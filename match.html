<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" /><meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>CareerWise — Career Matching</title>
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
  <style>
    :root{ --bg:#ffffff; --surface:#ffffff; --border:#e5e7eb; --text:#0f172a; --muted:#6b7280; --primary:#3165ff; --primary-600:#2656f5; --radius:14px; --shadow:0 10px 30px rgba(15,23,42,.06) }
    *{box-sizing:border-box} body{margin:0;background:var(--bg);color:var(--text);font-family:"Inter",system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif}
    .container{max-width:1080px;margin:0 auto;padding:24px}
    .topbar{display:flex;align-items:center;justify-content:space-between;margin-bottom:8px}
    .brand{display:flex;align-items:center;gap:12px}
    .logo{width:36px;height:36px;border-radius:10px;background:linear-gradient(135deg,#7aa2ff 0%, #5a6bff 35%, #6a57ff 100%);box-shadow:var(--shadow)}
    .btn{display:inline-flex;align-items:center;justify-content:center;padding:10px 12px;border-radius:12px;border:1px solid var(--border);cursor:pointer;background:#fff;font-weight:600}
    .btn.primary{background:var(--primary);border-color:transparent;color:#fff}.btn.primary:hover{background:var(--primary-600)}
    .muted{color:var(--muted)}
    .card{background:var(--surface);border:1px solid var(--border);border-radius:var(--radius);box-shadow:var(--shadow);padding:22px}
    .grid-2{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    @media (max-width:700px){.grid-2{grid-template-columns:1fr}}
    .match{border:1px solid var(--border);border-radius:16px;padding:16px;background:#fff}
    .match .hdr{display:flex;align-items:center;justify-content:space-between}
    .badge-pill{font-size:12px;padding:6px 10px;border-radius:999px;background:#eef2ff;color:#1d4ed8;border:1px solid #c7d2fe}
  </style>
</head>
<body>
  <div class="container">
    <div class="topbar">
      <div class="brand"><div class="logo"></div><strong>CareerWise</strong></div>
      <div style="display:flex;align-items:center;gap:10px">
        <span id="who" class="muted"></span>
        <span id="badge" class="badge">U</span>
        <a class="btn" href="dashboard.html">← Dashboard</a>
        <button id="signOutBtn" class="btn">Sign out</button>
      </div>
    </div>

    <section class="card">
      <h3 style="margin:0">Career Matching</h3>
      <p class="muted" style="margin-top:6px">We use your latest psychometric results plus your skills & interests.</p>

      <div class="grid-2" style="margin-top:12px;">
        <input id="skills" class="btn" style="text-align:left" placeholder="Skills (comma separated)" value="sql, excel" />
        <input id="interests" class="btn" style="text-align:left" placeholder="Interests (comma separated)" value="data, analytics" />
      </div>

      <div style="display:flex;gap:10px;margin-top:12px">
        <button id="matchBtn" class="btn primary" type="button">Get Matches</button>
        <span id="mErr" class="muted" style="display:none"></span>
      </div>

      <div id="latest" class="muted" style="margin-top:10px"></div>
      <div id="matches" style="display:flex;flex-direction:column;gap:12px;margin-top:14px"></div>
    </section>
  </div>

  <script type="module">
    import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/+esm";
    const SUPABASE_URL="https://awsuhluvyrxwmogzyfhr.supabase.co";
    const SUPABASE_ANON_KEY="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImF3c3VobHV2eXJ4d21vZ3p5ZmhyIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTcwNTI5NzksImV4cCI6MjA3MjYyODk3OX0.L_Ye8GAeC61xiW67a_bCTP5Wr7UtRja7o4_Y6mDwaLE";
    const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
    window.__sb = supabase;

    const params = new URLSearchParams(location.search);
    if (params.has('code') || params.has('token_hash') || location.hash.includes('access_token')) {
      try { const { error } = await supabase.auth.exchangeCodeForSession(location.href); if(!error) history.replaceState({}, '', location.pathname); } catch {}
    }

    async function requireAuth(){
      const { data:{session} } = await supabase.auth.getSession();
      const guest = localStorage.getItem("cw_guest_id");
      if(session){ setupUser(session.user.email); window.__uid=session.user.id; return; }
      if(guest){ setupUser(`Guest: ${guest.replace("guest_","G-")}`); return; }
      location.href="index.html";
    }
    function setupUser(label){
      who.textContent = label; const b=document.createElement('span'); b.className='badge'; b.textContent=(label||'U').slice(0,1).toUpperCase();
      const badgeHolder=document.getElementById('badge'); badgeHolder?.replaceWith(b); b.id='badge';
      signOutBtn.onclick = async ()=>{ await supabase.auth.signOut().catch(()=>{}); localStorage.removeItem("cw_guest_id"); location.href="index.html"; };
    }
    await requireAuth();

    // Fetch latest psychometric result
    async function getLatestResult(){
      const uid = window.__uid;
      if(!uid) return null;
      const { data, error } = await supabase
        .from('results')
        .select('traits, sections, badges, summary, created_at')
        .eq('user_id', uid)
        .order('created_at', { ascending:false })
        .limit(1);
      if(error) return null;
      return data?.[0] || null;
    }

    function cosine(a,b){
      const keys=new Set([...Object.keys(a),...Object.keys(b)]); let dot=0,na=0,nb=0;
      keys.forEach(k=>{ const x=a[k]||0, y=b[k]||0; dot+=x*y; na+=x*x; nb+=y*y; });
      const d=Math.sqrt(na)*Math.sqrt(nb)||1; return dot/d;
    }

    async function fetchCareers(){
      const { data } = await supabase.from('careers').select('title,traits,description');
      return data||[];
    }

    document.getElementById('matchBtn').onclick = async ()=>{
      mErr.style.display='none'; matches.innerHTML='Loading…';
      const latest = await getLatestResult();
      if(!latest){ matches.innerHTML=''; mErr.textContent='No psychometric results found. Please take the test first.'; mErr.style.display='inline'; return; }
      latestEl(latest);

      // vector from traits (0..1)
      const u={}; (latest.traits||[]).forEach(t=>u[t.name]= (t.score||0)/100);

      // optionally factor skills/interests as soft boosts (very simple)
      const skills = (document.getElementById('skills').value||'').toLowerCase();
      const interests = (document.getElementById('interests').value||'').toLowerCase();

      const careers = await fetchCareers();
      const ranked = careers.map(c=>{
        const ct={}; Object.entries(c.traits||{}).forEach(([k,v])=>ct[k]=Number(v)||0);
        let base = Math.max(0, cosine(u, ct));
        // soft text boost
        const text = (c.title + ' ' + (c.description||'')).toLowerCase();
        let boost = 0;
        skills.split(',').map(s=>s.trim()).filter(Boolean).forEach(s=>{ if(text.includes(s)) boost += 0.03; });
        interests.split(',').map(s=>s.trim()).filter(Boolean).forEach(s=>{ if(text.includes(s)) boost += 0.03; });
        return {...c, score: Math.round(Math.min(1, base + boost)*100) };
      }).sort((a,b)=>b.score-a.score).slice(0,5);

      matches.innerHTML='';
      ranked.forEach(r=>{
        const card=document.createElement('div'); card.className='match';
        card.innerHTML = `
          <div class="hdr"><div style="font-weight:700">${r.title}</div>
            <span class="badge-pill">${r.score}% fit</span></div>
          <p class="muted" style="margin:6px 0 0;white-space:pre-wrap">${r.description||''}</p>`;
        matches.appendChild(card);
      });
    };

    function latestEl(latest){
      latest.innerHTML = `Using your latest assessment from <strong>${new Date(latest.created_at).toLocaleString()}</strong>.`;
    }

    const latest = document.getElementById('latest');
    const matches = document.getElementById('matches');
    const mErr = document.getElementById('mErr');
  </script>
</body>
</html>
