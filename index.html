<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no"/>
  <title>CareerWise — Discover Your Best-Fit Career</title>

  <!-- Inter font -->
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">

  <link rel="icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 64 64'%3E%3Crect rx='14' width='64' height='64' fill='%234f7cff'/%3E%3Ctext x='50%25' y='58%25' text-anchor='middle' font-size='38' font-family='Inter' fill='white'%3ECW%3C/text%3E%3C/svg%3E" />

  <style>
    :root{
      --bg: #0b1020;
      --card: rgba(255,255,255,0.06);
      --card-strong: rgba(255,255,255,0.12);
      --stroke: rgba(255,255,255,0.12);
      --text: #e6eaf2;
      --muted: #a8b0c3;
      --primary: #4f7cff;          /* buttons */
      --love: #2563eb;             /* word "love" */
      --success: #22c55e;
      --warning: #f59e0b;
      --danger: #ef4444;
      --shadow: 0 10px 30px rgba(0,0,0,.35), inset 0 1px 0 rgba(255,255,255,.06);
      --radius: 16px;
      --radius-sm: 10px;
      --radius-lg: 22px;
      --blur: 12px;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family:"Inter",system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;
      color:var(--text);
      background:
        radial-gradient(1200px 700px at 15% 5%, #192447 0%, transparent 55%),
        radial-gradient(900px 600px at 90% 10%, #40286f 0%, transparent 55%),
        radial-gradient(900px 600px at 50% 100%, #1d3b62 0%, transparent 60%),
        var(--bg);
    }
    a{color:var(--primary); text-decoration:none}
    .container{max-width:1100px;margin:0 auto;padding:32px}
    .stack{display:grid;gap:28px}
    .hidden{display:none !important}

    /* Header */
    .topbar{display:flex;align-items:center;justify-content:space-between;margin-bottom:12px}
    .brand{display:flex;align-items:center;gap:12px}
    .logo{width:36px;height:36px;border-radius:10px;background:linear-gradient(135deg,#7aa2ff 0%, #5a6bff 35%, #6a57ff 100%);box-shadow:var(--shadow)}
    .brand h1{font-size:20px;margin:0;font-weight:700;letter-spacing:.3px}
    .chip{font-size:12px;color:var(--muted);border:1px solid var(--stroke);padding:6px 10px;border-radius:999px;background:var(--card);backdrop-filter: blur(var(--blur))}

    /* Hero */
    .hero h2{font-size:40px;line-height:1.15;margin:6px 0 6px;font-weight:800;color:#eaf0ff}
    .love{color:var(--love); text-shadow:0 6px 24px rgba(37,99,235,.25)}
    .sub{color:#cfd7ea;font-weight:700}

    /* Cards */
    .card{background:var(--card); border:1px solid var(--stroke);border-radius:var(--radius); box-shadow: var(--shadow);backdrop-filter: blur(var(--blur)); padding:22px}
    .section-title{font-size:22px;font-weight:700;margin:0 0 8px}
    .muted{color:var(--muted);font-size:14px}

    /* Auth layout */
    .auth-grid{display:grid;grid-template-columns:1.1fr .9fr;gap:22px}
    @media (max-width: 860px){ .auth-grid{grid-template-columns:1fr} }

    /* Tabs – neutral (no blue fill) */
    .tabs{display:flex;gap:8px;margin-bottom:14px}
    .tab{
      padding:9px 12px;border-radius:10px;border:1px solid var(--stroke);
      background:rgba(255,255,255,0.04);color:var(--text);font-weight:600;font-size:13px;cursor:pointer
    }
    .tab.is-active{outline:2px solid rgba(255,255,255,.18)} /* subtle, not blue */

    /* Mode toggles (Login vs Signup) */
    .seg{display:flex;gap:8px;margin-bottom:12px}
    .seg .ghost{padding:8px 10px;border-radius:10px;border:1px solid var(--stroke);background:var(--card);color:var(--text);font-weight:600;font-size:12px;cursor:pointer}
    .seg .ghost.is-active{background:rgba(255,255,255,0.08);border-color:rgba(255,255,255,0.22)}

    /* Inputs / buttons */
    .input{width:100%;padding:12px 14px;border-radius:12px;border:1px solid var(--stroke);background:rgba(255,255,255,0.04);color:var(--text);outline:none}
    .input::placeholder{color:#94a3b8}
    .btn{display:inline-flex;align-items:center;justify-content:center;gap:8px;padding:12px 14px;border-radius:12px;border:0;cursor:pointer;font-weight:700;color:#fff;background:linear-gradient(180deg,#6b8aff,#4f7cff);box-shadow:var(--shadow)}
    .btn.secondary{background:rgba(255,255,255,0.06);border:1px solid var(--stroke);color:var(--text)}
    .btn.success{background:linear-gradient(180deg,#36d676,#22c55e)}
    .inline-note{font-size:13px;margin-top:8px}
    .note-ok{color:#86efac}.note-err{color:#fda4af}
    .spinner{width:16px;height:16px;border-radius:999px;border:2px solid rgba(255,255,255,.3);border-top-color:#fff;animation:spin 1s linear infinite}
    @keyframes spin{to{transform:rotate(360deg)}}

    /* Lists / chips */
    .chips{display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:10px}
    .chip-row{display:flex;align-items:center;justify-content:space-between;border:1px solid var(--stroke);border-radius:12px;padding:10px 12px;background:rgba(255,255,255,0.04)}

    /* Questions */
    .q{border:1px solid var(--stroke);border-radius:12px;padding:14px;background:rgba(255,255,255,0.04)}
    .rate{display:flex;gap:8px;margin-top:8px}
    .rate button{width:38px;height:38px;border-radius:12px;border:1px solid var(--stroke);background:rgba(255,255,255,0.06);color:var(--text);font-weight:700;cursor:pointer}
    .rate button.is-on{background:var(--primary)}
    .grid-2{display:grid;grid-template-columns:1fr 1fr;gap:12px}

    /* Matches */
    .match{border:1px solid var(--stroke);border-radius:16px;padding:16px;background:rgba(255,255,255,0.05)}
    .match .hdr{display:flex;align-items:center;justify-content:space-between}
    .badge{font-size:12px;padding:6px 10px;border-radius:999px;background:rgba(79,124,255,.18);color:#cfe0ff;border:1px solid rgba(79,124,255,.4)}

    footer{color:var(--muted);text-align:center;font-size:12px;margin-top:8px}
  </style>
</head>
<body>
  <div class="container stack">
    <!-- Top -->
    <div class="topbar" aria-label="Header">
      <div class="brand">
        <div class="logo" aria-hidden="true"></div>
        <h1>CareerWise</h1>
      </div>
      <div>
        <span class="chip">API: <strong id="api">https://careerwise-api.onrender.com</strong></span>
        <span class="chip" id="apiStatus">checking…</span>
      </div>
    </div>

    <!-- Hero -->
    <div class="hero">
      <h2>Find the work you <span class="love">love</span></h2>
      <div class="sub">Take a <strong>5-minute assessment</strong> and get <strong>precise, role-ready matches</strong>.</div>
    </div>

    <!-- ============ AUTH ============ -->
    <section id="authSection" class="card" aria-label="Authentication">
      <div class="auth-grid">
        <!-- Left: Email auth -->
        <div>
          <h3 class="section-title">Sign in</h3>
          <p class="muted">Keep your progress and get personalized matches.</p>

          <div class="tabs" role="tablist" aria-label="Sign in method">
            <button id="tabPwd" class="tab is-active" type="button" role="tab" aria-selected="true">Email + Password</button>
            <button id="tabMagic" class="tab" type="button" role="tab" aria-selected="false">Magic Link</button>
          </div>

          <!-- Password Panel -->
          <div id="panelPwd" role="tabpanel" aria-labelledby="tabPwd">
            <div class="seg" role="tablist" aria-label="Login vs Signup">
              <button id="btnShowLogin" class="ghost is-active" type="button" role="tab" aria-selected="true">Log in</button>
              <button id="btnShowSignup" class="ghost" type="button" role="tab" aria-selected="false">Sign up</button>
            </div>

            <form id="loginForm" class="stack" style="gap:10px;">
              <label class="muted" for="loginEmail">Email</label>
              <input id="loginEmail" class="input" type="email" autocomplete="email" placeholder="you@example.com" required>
              <label class="muted" for="loginPassword">Password</label>
              <input id="loginPassword" class="input" type="password" autocomplete="current-password" placeholder="Your password" required>
              <button class="btn" type="submit"><span id="loginSpin" class="spinner hidden"></span> Log in</button>
            </form>

            <form id="signupForm" class="stack hidden" style="gap:10px;margin-top:10px;">
              <label class="muted" for="signupEmail">Email</label>
              <input id="signupEmail" class="input" type="email" autocomplete="email" placeholder="you@example.com" required>
              <label class="muted" for="signupPassword">Password</label>
              <input id="signupPassword" class="input" type="password" autocomplete="new-password" minlength="6" placeholder="Create a password (min 6)" required>
              <button class="btn success" type="submit"><span id="signupSpin" class="spinner hidden"></span> Create account</button>
            </form>

            <p id="pwdMsg" class="inline-note muted hidden" role="status"></p>
          </div>

          <!-- Magic Panel -->
          <div id="panelMagic" class="hidden" role="tabpanel" aria-labelledby="tabMagic">
            <form id="emailForm" class="stack" style="gap:10px;">
              <label class="muted" for="emailInput">Email</label>
              <input id="emailInput" class="input" type="email" autocomplete="email" placeholder="you@example.com" required>
              <button class="btn" type="submit"><span id="magicSpin" class="spinner hidden"></span> Send magic link</button>
            </form>
            <p id="emailMsg" class="inline-note muted hidden" role="status"></p>
          </div>
        </div>

        <!-- Right: Guest -->
        <div>
          <h3 class="section-title">Or continue as guest</h3>
          <p class="muted">Try the app instantly. You can sign in any time to save.</p>
          <button id="guestBtn" class="btn success" style="width:100%;margin-top:10px;">Continue as guest</button>
          <div class="stack" style="gap:10px;margin-top:14px;">
            <div class="chip-row"><span>Storage</span><span class="muted">Local (this browser)</span></div>
            <div class="chip-row"><span>Privacy</span><span class="muted">No personal data stored</span></div>
          </div>
        </div>
      </div>

      <!-- Signed-in bar -->
      <div id="authUserBar" class="hidden" style="margin-top:18px;">
        <div class="chip-row" style="align-items:center;">
          <div style="display:flex;align-items:center;gap:10px;">
            <div id="userBadge" style="width:34px;height:34px;border-radius:10px;background:linear-gradient(180deg,#6b8aff,#4f7cff);display:grid;place-items:center;font-weight:800;">U</div>
            <div id="userLabel" style="font-weight:700;">Signed in</div>
          </div>
          <button id="signOutBtn" class="btn secondary" type="button">Sign out</button>
        </div>
      </div>
    </section>

    <!-- ============ APP (next-page view) ============ -->
    <div id="appRoot" class="stack hidden">
      <section class="card" aria-label="Psychometric Analysis">
        <div class="topbar" style="margin:0 0 10px">
          <h3 class="section-title" style="margin:0">Psychometric Analysis</h3>
          <div class="stack" style="grid-auto-flow:column;gap:8px;display:grid;">
            <button id="btnReloadApi" class="btn secondary" type="button">Reload from API</button>
            <button id="btnLoadDemo" class="btn secondary" type="button">Load Demo Questions</button>
          </div>
        </div>
        <p class="muted">Answer quickly on a 1–5 scale.</p>

        <div id="questions" class="stack" style="gap:10px;margin-top:12px;"></div>

        <div class="grid-2" style="margin-top:12px;">
          <input id="skills" class="input" placeholder="Skills (comma separated)" value="sql, excel" />
          <input id="interests" class="input" placeholder="Interests (comma separated)" value="data, analytics" />
        </div>

        <div style="margin-top:12px;display:flex;gap:10px;align-items:center;">
          <button id="analyzeBtn" class="btn" type="button"><span id="analyzeSpin" class="spinner hidden"></span> Run Analysis</button>
          <span id="pErr" class="inline-note note-err hidden"></span>
        </div>

        <div id="analysis" class="hidden" style="margin-top:16px;">
          <div class="card" style="background:rgba(255,255,255,0.04)">
            <h4 style="margin:0 0 6px;font-size:16px;">Summary</h4>
            <p id="summary" class="muted" style="white-space:pre-wrap;margin:0"></p>

            <h4 style="margin:14px 0 6px;font-size:16px;">Traits</h4>
            <div id="traits" class="chips"></div>

            <h4 style="margin:14px 0 6px;font-size:16px;">Cautions</h4>
            <ul id="cautions" style="margin:0 0 0 18px;color:#dfe6ff"></ul>
          </div>
        </div>
      </section>

      <section class="card" aria-label="Career Match">
        <h3 class="section-title">Career Match</h3>
        <p class="muted">Uses traits, skills, and interests above.</p>
        <div style="display:flex;gap:10px;margin-top:8px;align-items:center;">
          <button id="matchBtn" class="btn success" type="button"><span id="matchSpin" class="spinner hidden"></span> Get Matches</button>
          <span id="mErr" class="inline-note note-err hidden"></span>
        </div>
        <div id="matches" class="stack" style="gap:12px;margin-top:14px;"></div>
      </section>

      <footer>© 2025 CareerWise. Demo-only—no personal data stored in guest mode.</footer>
    </div>
  </div>

  <!-- ===================== APP LOGIC ===================== -->
  <script>
    const API = "https://careerwise-api.onrender.com";

    // "Next page" helpers (app view lives at #app)
    function goToApp() {
      document.getElementById('authSection').classList.add('hidden');
      document.getElementById('appRoot').classList.remove('hidden');
      if (location.hash !== '#app') {
        history.pushState({}, '', '#app');
      }
      window.scrollTo({ top: 0, behavior: 'smooth' });
    }
    function goToAuth() {
      document.getElementById('authSection').classList.remove('hidden');
      document.getElementById('appRoot').classList.add('hidden');
      if (location.hash) history.replaceState({}, '', location.pathname);
    }
    // open app directly if URL already has #app
    if (location.hash === '#app') {
      goToApp();
    }

    const demoQuestions = [
      { id: 'q1', text: 'I enjoy solving complex problems.', dimension: 'Analytical Thinking' },
      { id: 'q2', text: 'I communicate my ideas clearly.', dimension: 'Communication' },
      { id: 'q3', text: 'I like experimenting with new ideas.', dimension: 'Creativity' },
      { id: 'q4', text: 'I stay focused until tasks are complete.', dimension: 'Persistence' },
      { id: 'q5', text: 'I collaborate well in teams.', dimension: 'Collaboration' }
    ];

    const questionsEl = document.getElementById('questions');
    const apiStatus = document.getElementById('apiStatus');
    const pErr = document.getElementById('pErr');
    const mErr = document.getElementById('mErr');

    // Local persistence of answers
    const LS_KEY = "cw_answers_v1";
    function saveAnswersLocal(answers){ try{ localStorage.setItem(LS_KEY, JSON.stringify(answers)); }catch{} }
    function readAnswersLocal(){ try{ return JSON.parse(localStorage.getItem(LS_KEY) || "[]"); }catch{ return []; } }

    function renderQuestions(list){
      questionsEl.innerHTML = '';
      const saved = new Map(readAnswersLocal().map(a=>[a.id, a.value]));
      list.forEach((q, idx) => {
        const selected = saved.get(q.id) || 0;
        const row = document.createElement('div');
        row.className = 'q';
        row.innerHTML = `
          <div style="font-weight:600">${idx+1}. ${q.text}</div>
          <div class="rate" role="radiogroup" aria-label="Rating for ${q.text}" data-qid="${q.id}">
            ${[1,2,3,4,5].map(v => `<button type="button" aria-pressed="${selected===v}" data-v="${v}" class="${selected===v?'is-on':''}">${v}</button>`).join('')}
          </div>
        `;
        questionsEl.appendChild(row);
      });
    }

    questionsEl.addEventListener('click', (e) => {
      const btn = e.target.closest('button[data-v]');
      if (!btn) return;
      const group = btn.parentElement;
      group.querySelectorAll('button').forEach(b => { b.classList.remove('is-on'); b.setAttribute('aria-pressed','false'); });
      btn.classList.add('is-on'); btn.setAttribute('aria-pressed','true');
      group.setAttribute('data-selected', btn.getAttribute('data-v'));
      const answers = readAnswers();
      saveAnswersLocal(answers);
    });

    function readAnswers(){
      const rows = questionsEl.querySelectorAll('div.rate[data-qid]');
      const answers = [];
      rows.forEach(row => {
        const id = row.getAttribute('data-qid');
        const v = Number(row.getAttribute('data-selected') || 0);
        if (v) answers.push({ id, value: v });
      });
      const ids = new Set(answers.map(a=>a.id));
      document.querySelectorAll('div.rate[data-qid]').forEach(row=>{
        const id = row.getAttribute('data-qid');
        if (!ids.has(id)) answers.push({ id, value: 3 });
      });
      return answers;
    }

    async function pingApi(){
      try{
        const ac = new AbortController();
        const t = setTimeout(() => ac.abort(), 3000);
        const r = await fetch(API + '/api/health', { signal: ac.signal, cache: 'no-store' });
        clearTimeout(t);
        if (r.ok){
          apiStatus.textContent = 'online';
          apiStatus.style.background = 'linear-gradient(180deg,#36d676,#22c55e)';
          return true;
        }
        throw new Error();
      }catch{
        apiStatus.textContent = 'offline (demo)';
        apiStatus.style.background = 'linear-gradient(180deg,#fbbf24,#f59e0b)';
        return false;
      }
    }

    async function loadFromApiOrDemo(){
      const online = await pingApi();
      if (!online) { renderQuestions(demoQuestions); return; }
      try{
        const ac = new AbortController();
        const t = setTimeout(() => ac.abort(), 3000);
        const r = await fetch(API + '/api/psychometrics/questions', { signal: ac.signal, cache: 'no-store' });
        clearTimeout(t);
        if (!r.ok) throw new Error('API ' + r.status);
        const data = await r.json();
        renderQuestions(Array.isArray(data.questions) ? data.questions : demoQuestions);
      }catch{
        renderQuestions(demoQuestions);
      }
    }

    async function apiFetch(url, opts = {}){
      const options = { ...opts, headers: { ...(opts.headers || {}) } };
      if (window.__supabaseGetSession){
        try{
          const token = await window.__supabaseGetSession();
          if (token) options.headers["Authorization"] = "Bearer " + token;
        }catch{}
      }
      if (!options.headers["Authorization"]){
        const gid = localStorage.getItem("cw_guest_id");
        if (gid) options.headers["x-guest-id"] = gid;
      }
      return fetch(url, options);
    }

    document.getElementById('btnLoadDemo').addEventListener('click', () => renderQuestions(demoQuestions));
    document.getElementById('btnReloadApi').addEventListener('click', () => loadFromApiOrDemo());

    document.getElementById('analyzeBtn').addEventListener('click', async () => {
      pErr.classList.add('hidden');
      document.getElementById('analyzeSpin').classList.remove('hidden');
      try{
        const payload = {
          answers: readAnswers(),
          skills: document.getElementById('skills').value.split(',').map(s=>s.trim()).filter(Boolean),
          interests: document.getElementById('interests').value.split(',').map(s=>s.trim()).filter(Boolean),
          studentId: 's1'
        };
        const r = await apiFetch(API + '/api/psychometrics/analyze', {
          method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(payload)
        });
        if (!r.ok) throw new Error('Analyze failed ('+r.status+')');
        const data = await r.json();

        document.getElementById('summary').textContent = data.summary || '';

        const traits = document.getElementById('traits');
        traits.innerHTML = '';
        (data.traits||[]).forEach(t => {
          const row = document.createElement('div');
          row.className = 'chip-row';
          row.innerHTML = `<span>${t.name}</span><span class="muted">${t.score}/100</span>`;
          traits.appendChild(row);
        });

        const cautions = document.getElementById('cautions');
        cautions.innerHTML = '';
        (data.cautions||[]).forEach(c => {
          const li = document.createElement('li');
          li.textContent = c; cautions.appendChild(li);
        });

        document.getElementById('analysis').classList.remove('hidden');
      }catch(err){
        pErr.textContent = err.message || 'Analyze error';
        pErr.classList.remove('hidden');
      }finally{
        document.getElementById('analyzeSpin').classList.add('hidden');
      }
    });

    document.getElementById('matchBtn').addEventListener('click', async () => {
      mErr.classList.add('hidden');
      document.getElementById('matchSpin').classList.remove('hidden');
      try{
        const body = {
          skills: document.getElementById('skills').value.split(',').map(s=>s.trim()).filter(Boolean),
          interests: document.getElementById('interests').value.split(',').map(s=>s.trim()).filter(Boolean),
          traits: [], topK: 5, studentId:'s1'
        };
        const r = await apiFetch(API + '/api/matching/careers', {
          method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(body)
        });
        if (!r.ok) throw new Error('Matching failed ('+r.status+')');
        const data = await r.json();

        const wrap = document.getElementById('matches');
        wrap.innerHTML = '';
        (data.results||[]).forEach(item => {
          const card = document.createElement('div');
          card.className = 'match';
          card.innerHTML = `
            <div class="hdr">
              <div style="font-weight:700">${item.title}</div>
              <span class="badge">${item.score}% fit</span>
            </div>
            <p class="muted" style="margin:6px 0 0; white-space:pre-wrap;">${item.why || ''}</p>
            ${Array.isArray(item.nextSteps) ? `
              <ul style="margin:8px 0 0 18px;color:#dfe6ff;">
                ${item.nextSteps.map(s=>`<li>${s}</li>`).join('')}
              </ul>` : ''}
          `;
          wrap.appendChild(card);
        });
      }catch(err){
        mErr.textContent = err.message || 'Match error';
        mErr.classList.remove('hidden');
      }finally{
        document.getElementById('matchSpin').classList.add('hidden');
      }
    });

    // initial
    loadFromApiOrDemo();
  </script>

  <!-- ===================== SUPABASE AUTH (Magic-link + Password) ===================== -->
  <script type="module">
    import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/+esm";

    const SUPABASE_URL = "https://awsuhluvyrxwmogzyfhr.supabase.co";
    const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImF3c3VobHV2eXJ4d21vZ3p5ZmhyIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTcwNTI5NzksImV4cCI6MjA3MjYyODk3OX0.L_Ye8GAeC61xiW67a_bCTP5Wr7UtRja7o4_Y6mDwaLE";

    const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    window.__supabaseGetSession = async () => {
      const { data:{session} } = await supabase.auth.getSession();
      return session?.access_token || null;
    };

    // Tabs
    const tabPwd = document.getElementById('tabPwd');
    const tabMagic = document.getElementById('tabMagic');
    const panelPwd = document.getElementById('panelPwd');
    const panelMagic = document.getElementById('panelMagic');
    tabPwd.addEventListener('click', () => {
      tabPwd.classList.add('is-active'); tabMagic.classList.remove('is-active');
      panelPwd.classList.remove('hidden'); panelMagic.classList.add('hidden');
    });
    tabMagic.addEventListener('click', () => {
      tabMagic.classList.add('is-active'); tabPwd.classList.remove('is-active');
      panelMagic.classList.remove('hidden'); panelPwd.classList.add('hidden');
    });

    // Login vs Signup
    const btnShowLogin = document.getElementById('btnShowLogin');
    const btnShowSignup = document.getElementById('btnShowSignup');
    const loginForm = document.getElementById('loginForm');
    const signupForm = document.getElementById('signupForm');
    btnShowLogin.addEventListener('click', () => {
      btnShowLogin.classList.add('is-active'); btnShowSignup.classList.remove('is-active');
      loginForm.classList.remove('hidden'); signupForm.classList.add('hidden');
    });
    btnShowSignup.addEventListener('click', () => {
      btnShowSignup.classList.add('is-active'); btnShowLogin.classList.remove('is-active');
      signupForm.classList.remove('hidden'); loginForm.classList.add('hidden');
    });

    // Magic-link code exchange (?code=...)
    async function handleMagicLinkReturn(){
      const qs = location.search;
      if (qs && new URLSearchParams(qs).has("code")){
        const { error } = await supabase.auth.exchangeCodeForSession(qs);
        if (!error) history.replaceState({}, document.title, location.pathname);
      }
    }

    const authSection = document.getElementById("authSection");
    const authUserBar = document.getElementById("authUserBar");
    const userBadge = document.getElementById("userBadge");
    const userLabel = document.getElementById("userLabel");
    const signOutBtn = document.getElementById("signOutBtn");
    const emailForm = document.getElementById("emailForm");
    const emailInput = document.getElementById("emailInput");
    const emailMsg = document.getElementById("emailMsg");
    const pwdMsg = document.getElementById("pwdMsg");
    const guestBtn = document.getElementById("guestBtn");

    function getGuestId(){
      let id = localStorage.getItem("cw_guest_id");
      if (!id){
        id = "guest_" + (crypto?.randomUUID?.() || Math.random().toString(36).slice(2));
        localStorage.setItem("cw_guest_id", id);
      }
      return id;
    }
    function isGuest(){ return !!localStorage.getItem("cw_guest_id"); }

    function setSignedInUI({ email, label, asGuest=false }){
      authUserBar.classList.remove('hidden');
      userBadge.textContent = (label || email || "U").slice(0,1).toUpperCase();
      userLabel.textContent = asGuest ? `Guest: ${label}` : (email || label || "Signed in");
      goToApp(); // <-- move to next page view
    }
    function setSignedOutUI(){
      authUserBar.classList.add('hidden');
      goToAuth();
    }

    // Email + Password: login (only this button triggers it)
    loginForm.addEventListener("submit", async (e)=>{
      e.preventDefault();
      pwdMsg.classList.add('hidden');
      document.getElementById('loginSpin').classList.remove('hidden');
      const email = (document.getElementById('loginEmail').value||'').trim();
      const password = document.getElementById('loginPassword').value;
      try{
        const { data, error } = await supabase.auth.signInWithPassword({ email, password });
        if (error) throw error;
        setSignedInUI({ email: data.user.email });
        pwdMsg.textContent = "Welcome back!";
        pwdMsg.classList.remove('hidden'); pwdMsg.classList.add('note-ok'); pwdMsg.classList.remove('note-err');
      }catch(err){
        pwdMsg.textContent = err.message || "Login failed";
        pwdMsg.classList.remove('hidden'); pwdMsg.classList.add('note-err'); pwdMsg.classList.remove('note-ok');
      }finally{
        document.getElementById('loginSpin').classList.add('hidden');
      }
    });

    // Email + Password: signup (confirmation still required)
    signupForm.addEventListener("submit", async (e)=>{
      e.preventDefault();
      pwdMsg.classList.add('hidden');
      document.getElementById('signupSpin').classList.remove('hidden');
      const email = (document.getElementById('signupEmail').value||'').trim();
      const password = document.getElementById('signupPassword').value;
      try{
        const { error } = await supabase.auth.signUp({
          email, password,
          options: { emailRedirectTo: location.origin + location.pathname }
        });
        if (error) throw error;
        pwdMsg.textContent = "Check your inbox to confirm your email.";
        pwdMsg.classList.remove('hidden'); pwdMsg.classList.add('note-ok'); pwdMsg.classList.remove('note-err');
      }catch(err){
        pwdMsg.textContent = err.message || "Signup failed";
        pwdMsg.classList.remove('hidden'); pwdMsg.classList.add('note-err'); pwdMsg.classList.remove('note-ok');
      }finally{
        document.getElementById('signupSpin').classList.add('hidden');
      }
    });

    // Magic link
    emailForm.addEventListener("submit", async (e)=>{
      e.preventDefault();
      emailMsg.classList.add('hidden');
      document.getElementById('magicSpin').classList.remove('hidden');
      const email = (emailInput.value||'').trim();
      try{
        const { error } = await supabase.auth.signInWithOtp({
          email, options:{ emailRedirectTo: location.origin + location.pathname }
        });
        if (error) throw error;
        emailMsg.textContent = "Magic link sent! Check your inbox.";
        emailMsg.classList.remove('hidden'); emailMsg.classList.remove('note-err'); emailMsg.classList.add('note-ok');
      }catch(err){
        emailMsg.textContent = "Failed to send link: " + (err?.message || "Unknown error");
        emailMsg.classList.remove('hidden'); emailMsg.classList.add('note-err'); emailMsg.classList.remove('note-ok');
      }finally{
        document.getElementById('magicSpin').classList.add('hidden');
      }
    });

    // Guest
    guestBtn.addEventListener('click', ()=>{
      const id = getGuestId();
      setSignedInUI({ label: id.replace("guest_","G-"), asGuest:true });
    });

    // Sign out
    document.getElementById('signOutBtn').addEventListener('click', async ()=>{
      await supabase.auth.signOut();
      localStorage.removeItem("cw_guest_id");
      setSignedOutUI();
    });

    async function initAuth(){
      await handleMagicLinkReturn();
      const { data:{session} } = await supabase.auth.getSession();
      if (session?.user){
        setSignedInUI({ email: session.user.email });
      } else if (isGuest()){
        const id = getGuestId();
        setSignedInUI({ label: id.replace("guest_","G-"), asGuest:true });
      } else {
        setSignedOutUI();
      }
      supabase.auth.onAuthStateChange((_event, sess)=>{
        if (sess?.user){
          setSignedInUI({ email: sess.user.email });
        } else if (isGuest()){
          const id = getGuestId();
          setSignedInUI({ label: id.replace("guest_","G-"), asGuest:true });
        } else {
          setSignedOutUI();
        }
      });
    }
    initAuth();
  </script>
</body>
</html>
