<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>CareerWise Demo</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-50 text-gray-800">

  <!-- ===================== AUTH (Email OTP or Guest) ===================== -->
  <section id="authSection" class="min-h-[30vh] bg-white/70 border-b">
    <div class="max-w-3xl mx-auto px-6 py-8">
      <!-- Header -->
      <div class="flex items-center justify-between">
        <div>
          <h1 class="text-2xl font-semibold">CareerWise</h1>
          <p class="text-sm text-slate-500">Sign in to take the test and save results.</p>
        </div>
        <div id="authUserBar" class="hidden items-center gap-3">
          <div id="userBadge" class="h-9 w-9 rounded-full bg-blue-600 text-white grid place-items-center font-semibold"></div>
          <div class="text-sm">
            <div id="userLabel" class="font-medium"></div>
            <button id="signOutBtn" class="text-red-600 hover:underline">Sign out</button>
          </div>
        </div>
      </div>

      <!-- Login Card -->
      <div id="authCard" class="mt-6 grid md:grid-cols-2 gap-6">
        <!-- Email OTP -->
        <div class="rounded-2xl border bg-white p-5 shadow-sm">
          <h2 class="font-semibold">Sign in with email</h2>
          <p class="text-sm text-slate-500 mb-3">We’ll email you a secure magic link.</p>
          <form id="emailForm" class="space-y-3">
            <input id="emailInput" type="email" required
                  class="w-full rounded-lg border px-3 py-2"
                  placeholder="you@example.com" />
            <button type="submit"
                    class="w-full rounded-lg bg-blue-600 px-4 py-2 text-white hover:bg-blue-700">
              Send magic link
            </button>
          </form>
          <p id="emailMsg" class="text-sm text-slate-600 mt-2 hidden"></p>
        </div>

        <!-- Guest Mode -->
        <div class="rounded-2xl border bg-white p-5 shadow-sm">
          <h2 class="font-semibold">Or continue as guest</h2>
          <p class="text-sm text-slate-500 mb-3">
            Try the app without email. Results are stored in your browser.
          </p>
          <button id="guestBtn"
                  class="w-full rounded-lg bg-emerald-600 px-4 py-2 text-white hover:bg-emerald-700">
            Continue as guest
          </button>
          <p class="text-xs text-slate-500 mt-2">You can sign in later to save to your account.</p>
        </div>
      </div>
    </div>
  </section>

  <!-- ===================== APP (hidden until signed-in/guest) ===================== -->
  <div id="appRoot" class="max-w-3xl mx-auto p-6 space-y-6 hidden">
    <header class="flex items-center justify-between">
      <h1 class="text-3xl font-bold text-blue-600">CareerWise — Demo</h1>
      <div class="text-xs text-gray-500">
        API: <span id="api">https://careerwise-api.onrender.com</span>
        <span id="apiStatus" class="ml-2 inline-block rounded px-2 py-0.5 bg-gray-200 text-gray-700">checking…</span>
      </div>
    </header>

    <section class="bg-white p-6 rounded-2xl shadow-sm">
      <div class="flex items-center justify-between">
        <h2 class="text-2xl font-semibold">Psychometric Analysis</h2>
        <div class="flex gap-2">
          <button id="btnReloadApi" class="px-3 py-1.5 rounded bg-slate-200 hover:bg-slate-300 text-sm">Reload from API</button>
          <button id="btnLoadDemo" class="px-3 py-1.5 rounded bg-slate-200 hover:bg-slate-300 text-sm">Load Demo Questions</button>
        </div>
      </div>
      <p class="text-gray-600 mb-4">Answer quickly on a 1–5 scale.</p>

      <div id="questions" class="space-y-3"></div>

      <div class="grid md:grid-cols-2 gap-3 mt-4">
        <input id="skills" class="border p-2 rounded-lg" placeholder="Skills (comma separated)" value="sql, excel" />
        <input id="interests" class="border p-2 rounded-lg" placeholder="Interests (comma separated)" value="data, analytics" />
      </div>

      <button id="analyzeBtn" class="mt-4 px-4 py-2 rounded-lg bg-blue-600 text-white hover:bg-blue-700">Run Analysis</button>
      <p id="pErr" class="text-red-600 mt-3 hidden"></p>

      <div id="analysis" class="mt-5 hidden">
        <div class="rounded-xl border p-4">
          <h3 class="font-semibold">Summary</h3>
          <p id="summary" class="mt-1 whitespace-pre-wrap"></p>
          <h3 class="font-semibold mt-4">Traits</h3>
          <ul id="traits" class="mt-1 grid sm:grid-cols-2 gap-2"></ul>
          <h3 class="font-semibold mt-4">Cautions</h3>
          <ul id="cautions" class="list-disc ml-6 text-sm"></ul>
        </div>
      </div>
    </section>

    <section class="bg-white p-6 rounded-2xl shadow-sm">
      <h2 class="text-2xl font-semibold mb-2">Career Match</h2>
      <p class="text-gray-600 mb-4">Uses traits/skills/interests above.</p>
      <button id="matchBtn" class="px-4 py-2 rounded-lg bg-green-600 text-white hover:bg-green-700">Get Matches</button>
      <p id="mErr" class="text-red-600 mt-3 hidden"></p>
      <div id="matches" class="mt-4 grid gap-3"></div>
    </section>

    <footer class="text-xs text-gray-500 text-center">
      Demo-only. No personal data stored.
    </footer>
  </div>

  <!-- ===================== APP SCRIPT ===================== -->
  <script>
  const API = "https://careerwise-api.onrender.com";

  const demoQuestions = [
    { id: 'q1', text: 'I enjoy solving complex problems.', dimension: 'Analytical Thinking' },
    { id: 'q2', text: 'I communicate my ideas clearly.', dimension: 'Communication' },
    { id: 'q3', text: 'I like experimenting with new ideas.', dimension: 'Creativity' },
    { id: 'q4', text: 'I stay focused until tasks are complete.', dimension: 'Persistence' },
    { id: 'q5', text: 'I collaborate well in teams.', dimension: 'Collaboration' }
  ];

  const questionsEl = document.getElementById('questions');
  const pErr = document.getElementById('pErr');
  const mErr = document.getElementById('mErr');
  const apiStatus = document.getElementById('apiStatus');

  function renderQuestions(list) {
    questionsEl.innerHTML = '';
    list.forEach((q, idx) => {
      const row = document.createElement('div');
      row.className = 'p-3 rounded-lg border';
      row.innerHTML = `
        <div class="font-medium mb-2">${idx+1}. ${q.text}</div>
        <div class="flex gap-2" data-qid="${q.id}">
          ${[1,2,3,4,5].map(v => `
            <button type="button"
                    class="px-3 py-1 rounded border bg-white hover:bg-gray-100"
                    data-v="${v}">${v}</button>`).join('')}
        </div>
      `;
      questionsEl.appendChild(row);
    });
  }

  questionsEl.addEventListener('click', (e) => {
    const btn = e.target.closest('button[data-v]');
    if (!btn) return;
    const row = btn.parentElement;
    row.querySelectorAll('button').forEach(b => b.classList.remove('bg-blue-600','text-white'));
    btn.classList.add('bg-blue-600','text-white');
    row.setAttribute('data-selected', btn.getAttribute('data-v'));
  });

  function readAnswers() {
    const rows = questionsEl.querySelectorAll('div[data-qid]');
    const answers = [];
    rows.forEach(row => {
      const id = row.getAttribute('data-qid');
      const v = row.getAttribute('data-selected') || '3';
      answers.push({ id, value: Number(v) });
    });
    return answers;
  }

  async function pingApi() {
    try {
      const ac = new AbortController();
      const t = setTimeout(() => ac.abort(), 3000);
      const r = await fetch(API + '/api/health', { signal: ac.signal, cache: 'no-store' });
      clearTimeout(t);
      if (r.ok) {
        apiStatus.textContent = 'online';
        apiStatus.className = 'ml-2 inline-block rounded px-2 py-0.5 bg-green-100 text-green-800';
        return true;
      }
      throw new Error();
    } catch {
      apiStatus.textContent = 'offline (using demo)';
      apiStatus.className = 'ml-2 inline-block rounded px-2 py-0.5 bg-yellow-100 text-yellow-800';
      return false;
    }
  }

  async function loadFromApiOrDemo() {
    const online = await pingApi();
    if (!online) { renderQuestions(demoQuestions); return; }
    try {
      const ac = new AbortController();
      const t = setTimeout(() => ac.abort(), 3000);
      const r = await fetch(API + '/api/psychometrics/questions', { signal: ac.signal, cache: 'no-store' });
      clearTimeout(t);
      if (!r.ok) throw new Error('API ' + r.status);
      const data = await r.json();
      renderQuestions(Array.isArray(data.questions) ? data.questions : demoQuestions);
    } catch {
      renderQuestions(demoQuestions);
    }
  }

  // Use this instead of fetch() so we can pass JWT or guest id
  async function apiFetch(url, opts = {}) {
    const options = { ...opts, headers: { ...(opts.headers || {}) } };
    // If Supabase is present, attach token; else fallback to guest header
    if (window.__supabaseGetSession) {
      try {
        const token = await window.__supabaseGetSession();
        if (token) options.headers["Authorization"] = "Bearer " + token;
      } catch {}
    }
    if (!options.headers["Authorization"]) {
      const gid = localStorage.getItem("cw_guest_id");
      if (gid) options.headers["x-guest-id"] = gid;
    }
    return fetch(url, options);
  }

  document.getElementById('btnLoadDemo').addEventListener('click', () => {
    renderQuestions(demoQuestions);
  });

  document.getElementById('btnReloadApi').addEventListener('click', () => {
    loadFromApiOrDemo();
  });

  document.getElementById('analyzeBtn').addEventListener('click', async () => {
    pErr.classList.add('hidden');
    try {
      const payload = {
        answers: readAnswers(),
        skills: document.getElementById('skills').value.split(',').map(s=>s.trim()).filter(Boolean),
        interests: document.getElementById('interests').value.split(',').map(s=>s.trim()).filter(Boolean),
        studentId: 's1'
      };
      const r = await apiFetch(API + '/api/psychometrics/analyze', {
        method: 'POST',
        headers: { 'Content-Type':'application/json' },
        body: JSON.stringify(payload)
      });
      if (!r.ok) throw new Error('Analyze failed (' + r.status + ')');
      const data = await r.json();

      document.getElementById('summary').textContent = data.summary || '';
      const traits = document.getElementById('traits');
      traits.innerHTML = '';
      (data.traits||[]).forEach(t => {
        const chip = document.createElement('li');
        chip.className = 'flex items-center justify-between rounded-lg border px-3 py-2';
        chip.innerHTML = `<span>${t.name}</span><span class="text-sm text-gray-600">${t.score}/100</span>`;
        traits.appendChild(chip);
      });
      const cautions = document.getElementById('cautions');
      cautions.innerHTML = '';
      (data.cautions||[]).forEach(c => {
        const li = document.createElement('li');
        li.textContent = c;
        cautions.appendChild(li);
      });
      document.getElementById('analysis').classList.remove('hidden');
    } catch (err) {
      pErr.textContent = err.message || 'Analyze error';
      pErr.classList.remove('hidden');
    }
  });

  document.getElementById('matchBtn').addEventListener('click', async () => {
    mErr.classList.add('hidden');
    try {
      const body = {
        skills: document.getElementById('skills').value.split(',').map(s=>s.trim()).filter(Boolean),
        interests: document.getElementById('interests').value.split(',').map(s=>s.trim()).filter(Boolean),
        traits: [], topK: 5, studentId:'s1'
      };
      const r = await apiFetch(API + '/api/matching/careers', {
        method: 'POST',
        headers: { 'Content-Type':'application/json' },
        body: JSON.stringify(body)
      });
      if (!r.ok) throw new Error('Matching failed (' + r.status + ')');
      const data = await r.json();

      const wrap = document.getElementById('matches');
      wrap.innerHTML = '';
      (data.results || []).forEach(item => {
        const card = document.createElement('div');
        card.className = 'rounded-xl border p-4';
        card.innerHTML = `
          <div class="flex items-center justify-between">
            <div class="font-semibold">${item.title}</div>
            <span class="text-xs px-2 py-1 rounded bg-blue-50 text-blue-700">${item.score}% fit</span>
          </div>
          <p class="mt-1 text-sm text-gray-700 whitespace-pre-wrap">${item.why || ''}</p>
          ${Array.isArray(item.nextSteps) ? `
            <ul class="list-disc ml-6 mt-2 text-sm text-gray-700">
              ${item.nextSteps.map(s=>`<li>${s}</li>`).join('')}
            </ul>` : ''}
        `;
        wrap.appendChild(card);
      });
    } catch (err) {
      mErr.textContent = err.message || 'Match error';
      mErr.classList.remove('hidden');
    }
  });

  // initial load
  loadFromApiOrDemo();
  </script>

  <!-- ===================== SUPABASE AUTH SCRIPT ===================== -->
  <!-- Replace SUPABASE_URL + SUPABASE_ANON_KEY with your own values -->
  <script type="module">
    import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/+esm";

    const SUPABASE_URL = "https://awsuhluvyrxwmogzyfhr.supabase.co";
    const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImF3c3VobHV2eXJ4d21vZ3p5ZmhyIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTcwNTI5NzksImV4cCI6MjA3MjYyODk3OX0.L_Ye8GAeC61xiW67a_bCTP5Wr7UtRja7o4_Y6mDwaLE";

    const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    // expose a helper so app script can get JWT if logged in
    window.__supabaseGetSession = async () => {
      const { data: { session } } = await supabase.auth.getSession();
      return session?.access_token || null;
    };

    // Elements
    const appRoot     = document.getElementById("appRoot");
    const authSection = document.getElementById("authSection");
    const authCard    = document.getElementById("authCard");
    const authUserBar = document.getElementById("authUserBar");
    const userBadge   = document.getElementById("userBadge");
    const userLabel   = document.getElementById("userLabel");
    const signOutBtn  = document.getElementById("signOutBtn");
    const emailForm   = document.getElementById("emailForm");
    const emailInput  = document.getElementById("emailInput");
    const emailMsg    = document.getElementById("emailMsg");
    const guestBtn    = document.getElementById("guestBtn");

    // ----- Guest handling -----
    function getGuestId() {
      let id = localStorage.getItem("cw_guest_id");
      if (!id) {
        id = "guest_" + (crypto?.randomUUID?.() || Math.random().toString(36).slice(2));
        localStorage.setItem("cw_guest_id", id);
      }
      return id;
    }
    function isGuest() {
      return !!localStorage.getItem("cw_guest_id");
    }

    // ----- UI state -----
    function setSignedInUI({ email, label, asGuest = false }) {
      // Top bar (signed-in)
      authUserBar.classList.remove("hidden");
      userBadge.textContent = (label || email || "U").slice(0, 1).toUpperCase();
      userLabel.textContent = asGuest ? `Guest: ${label}` : (email || label || "Signed in");

      // Hide login card; show app
      authCard.classList.add("hidden");
      authSection.classList.remove("bg-white/70", "border-b");
      appRoot.classList.remove("hidden");
    }

    function setSignedOutUI() {
      authUserBar.classList.add("hidden");
      authCard.classList.remove("hidden");
      authSection.classList.add("bg-white/70", "border-b");
      appRoot.classList.add("hidden");
    }

    // ----- Email OTP -----
    emailForm.addEventListener("submit", async (e) => {
      e.preventDefault();
      const email = emailInput.value.trim();
      if (!email) return;

      emailMsg.classList.add("hidden");
      try {
        const { error } = await supabase.auth.signInWithOtp({
          email,
          options: { emailRedirectTo: location.origin + location.pathname }
        });
        if (error) throw error;
        emailMsg.textContent = "Magic link sent! Check your inbox.";
        emailMsg.classList.remove("hidden");
        emailMsg.classList.remove("text-red-600");
      } catch (err) {
        emailMsg.textContent = "Failed to send link: " + (err?.message || "Unknown error");
        emailMsg.classList.remove("hidden");
        emailMsg.classList.add("text-red-600");
      }
    });

    // ----- Guest mode -----
    guestBtn.addEventListener("click", () => {
      const id = getGuestId();
      setSignedInUI({ label: id.replace("guest_", "G-"), asGuest: true });
    });

    // ----- Sign out -----
    signOutBtn.addEventListener("click", async () => {
      await supabase.auth.signOut();
      localStorage.removeItem("cw_guest_id");
      setSignedOutUI();
    });

    // ----- Initial state & auth changes -----
    async function initAuth() {
      const { data: { session } } = await supabase.auth.getSession();

      if (session?.user) {
        setSignedInUI({ email: session.user.email });
      } else if (isGuest()) {
        const id = getGuestId();
        setSignedInUI({ label: id.replace("guest_", "G-"), asGuest: true });
      } else {
        setSignedOutUI();
      }

      supabase.auth.onAuthStateChange((_event, sess) => {
        if (sess?.user) {
          setSignedInUI({ email: sess.user.email });
        } else if (isGuest()) {
          const id = getGuestId();
          setSignedInUI({ label: id.replace("guest_", "G-"), asGuest: true });
        } else {
          setSignedOutUI();
        }
      });
    }
    initAuth();
  </script>

</body>
</html>
