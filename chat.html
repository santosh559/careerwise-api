<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>CareerWise — Career Chatbot</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
  <style>
    :root{
      --bg:#f6f8fc;
      --card:#ffffff;
      --text:#0f172a;
      --muted:#64748b;
      --border:#e5e7eb;
      --accent:#3165ff;
      --accent-700:#2656f5;
      --shadow:0 10px 30px rgba(2,6,23,.07);
      --radius:16px;
    }
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);color:var(--text);font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif}
    .wrap{max-width:980px;margin:0 auto;padding:28px}
    .top{display:flex;align-items:center;justify-content:space-between;margin-bottom:16px}
    .brand{display:flex;align-items:center;gap:12px}
    .logo{width:40px;height:40px;border-radius:12px;background:linear-gradient(135deg,#7aa2ff 0%, #5a6bff 40%, #6a57ff 100%);box-shadow:var(--shadow)}
    .btn{display:inline-flex;align-items:center;gap:8px;padding:10px 14px;border:1px solid var(--border);border-radius:12px;background:#fff;font-weight:600;cursor:pointer}
    .card{background:var(--card);border:1px solid var(--border);border-radius:var(--radius);box-shadow:var(--shadow);padding:18px}
    .sub{color:var(--muted);font-size:13px}
    /* chat area */
    .chat{display:flex;flex-direction:column;gap:12px;margin-top:12px;min-height:320px;max-height:60vh;overflow:auto;padding-right:6px}
    .row{display:flex;gap:10px;align-items:flex-start}
    .avatar{width:32px;height:32px;border-radius:10px;background:#eef2ff;color:#1d4ed8;display:grid;place-items:center;font-weight:800;flex:0 0 auto}
    .avatar.me{background:#f1f5f9;color:#0f172a}
    .bubble{background:#fff;border:1px solid var(--border);border-radius:14px;padding:12px 14px;max-width:75%;box-shadow:0 4px 12px rgba(2,6,23,.04)}
    .me .bubble{background:#f8faff}
    .msg :where(p,ul,ol){margin:8px 0}
    .msg h3{margin:6px 0 2px}
    .chips{display:flex;gap:8px;flex-wrap:wrap;margin-top:8px}
    .chip{border:1px solid var(--border);border-radius:999px;padding:6px 10px;background:#fff;font-size:12px;color:#111827;cursor:pointer}
    .chip:hover{border-color:#cbd5e1}
    /* composer */
    .composer{display:flex;gap:8px;margin-top:12px;align-items:center}
    .input{flex:1;padding:12px 14px;border:1px solid var(--border);border-radius:12px;background:#fff;outline:none}
    .send{padding:10px 14px;border-radius:12px;border:1px solid var(--accent);background:var(--accent);color:#fff;font-weight:700;cursor:pointer}
    .send:disabled{opacity:.6;cursor:not-allowed}
    .ghost{opacity:.6}
    /* typing dots */
    .typing{display:inline-flex;gap:4px;align-items:center}
    .typing span{width:6px;height:6px;border-radius:50%;background:#94a3b8;display:inline-block;animation:blink 1.2s infinite}
    .typing span:nth-child(2){animation-delay:.15s}
    .typing span:nth-child(3){animation-delay:.3s}
    @keyframes blink{0%, 60%, 100%{opacity:.2} 30%{opacity:1}}
    /* mobile tweaks */
    @media (max-width:640px){ .bubble{max-width:100%} }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="top">
      <div class="brand"><div class="logo"></div><strong>CareerWise</strong></div>
      <a class="btn" href="dashboard.html">← Back</a>
    </div>

    <div class="card">
      <div style="display:flex;align-items:center;justify-content:space-between;gap:12px;flex-wrap:wrap">
        <div>
          <h2 style="margin:0 0 4px">Career Chatbot</h2>
          <div class="sub">I only answer career topics (roles, skills, roadmaps, resumes, interviews, job search, growth). Off-topic → I’ll steer you back.</div>
        </div>
      </div>

      <!-- Quick suggestions -->
      <div class="chips" id="chips">
        <button class="chip" data-q="Short roadmap to cloud engineer (beginner)">Roadmap: Cloud engineer</button>
        <button class="chip" data-q="Top 7 skills for data analyst in 2025">Skills: Data analyst</button>
        <button class="chip" data-q="Rewrite my resume summary for QA role: <paste here>">Resume summary (QA)</button>
        <button class="chip" data-q="Mock interview: product manager basics (5 questions)">Mock interview: PM</button>
      </div>

      <!-- Chat timeline -->
      <div id="chat" class="chat"></div>

      <!-- Composer -->
      <div class="composer">
        <input id="msg" class="input" placeholder="Ask a career question… e.g., 'How do I switch to AI from non-CS?'" />
        <button id="clear" class="btn ghost" type="button">Clear</button>
        <button id="send" class="send" type="button">Send</button>
      </div>
    </div>
  </div>

  <!-- Markdown + sanitize -->
  <script src="https://cdn.jsdelivr.net/npm/marked@12/marked.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/dompurify@3.1.7/dist/purify.min.js"></script>

  <script type="module">
  // ====== CONFIG ======
  const FN_URL = "https://awsuhluvyrxwmogzyfhr.supabase.co/functions/v1/chat-career";
  const ANON   = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImF3c3VobHV2eXJ4d21vZ3p5ZmhyIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTcwNTI5NzksImV4cCI6MjA3MjYyODk3OX0.L_Ye8GAeC61xiW67a_bCTP5Wr7UtRja7o4_Y6mDwaLE"; // <-- important

  // ====== ELEMENTS ======
  const chat = document.getElementById('chat');
  const msg  = document.getElementById('msg');
  const send = document.getElementById('send');
  const clearBtn = document.getElementById('clear');
  const chips = document.getElementById('chips');

  // ====== STATE ======
  const history = [];
  let busy = false;

  // ====== RENDER HELPERS ======
  function bubble({mine=false, html}) {
    const row = document.createElement('div');
    row.className = 'row' + (mine ? ' me' : '');
    const avatar = document.createElement('div');
    avatar.className = 'avatar' + (mine ? ' me' : '');
    avatar.textContent = mine ? 'You' : 'CW';
    const b = document.createElement('div');
    b.className = 'bubble msg';
    b.innerHTML = html;
    row.append(avatar, b);
    chat.append(row);
    chat.scrollTop = chat.scrollHeight;
  }

  function md(text){
    const html = marked.parse(text ?? "");
    return DOMPurify.sanitize(html);
  }

  function typing(show=true){
    if (show) {
      const row = document.createElement('div');
      row.className = 'row';
      row.id = 'typing-row';
      row.innerHTML = `
        <div class="avatar">CW</div>
        <div class="bubble"><div class="typing"><span></span><span></span><span></span></div></div>
      `;
      chat.append(row);
      chat.scrollTop = chat.scrollHeight;
    } else {
      const r = document.getElementById('typing-row');
      if (r) r.remove();
    }
  }

  // ====== INIT ======
  bubble({ html: md("Hi! I’m your **CareerWise** assistant. Ask me about careers—roles, skills, roadmaps, resumes, interviews. Off-topic? I’ll nudge you back.") });

  // ====== EVENTS ======
  if (chips) {
    chips.addEventListener('click', (e)=>{
      const q = e.target?.dataset?.q; if(!q) return;
      msg.value = q; send.click();
    });
  }
  clearBtn.onclick = ()=>{
    chat.innerHTML = '';
    history.length = 0;
    bubble({ html: md("Chat cleared. Ask me any **career** question to begin.") });
  };
  send.onclick = ask;
  msg.addEventListener('keydown', (e)=>{ if(e.key === 'Enter' && !e.shiftKey) ask(); });

  // ====== CORE ======
  async function ask(){
    const text = (msg.value || '').trim();
    if (!text || busy) return;
    busy = true; send.disabled = true;

    bubble({ mine:true, html: md(text) });
    history.push({ role: "user", content: text });
    msg.value = '';

    typing(true);
    try{
      const res = await fetch(FN_URL, {
        method: "POST",
        headers: { "Content-Type": "application/json", "Authorization": `Bearer ${ANON}` },
        body: JSON.stringify({ message: text, history })
      });

      // Helpful console logs for debugging
      console.log('[chat] status:', res.status);
      const raw = await res.text();
      console.log('[chat] raw:', raw);

      let data = {};
      try { data = JSON.parse(raw); } catch { /* leave data as {} */ }

      typing(false);

      // Be generous in what we accept from the function
      const reply =
        data?.reply ||
        data?.content ||
        data?.message ||
        data?.text ||
        data?.choices?.[0]?.message?.content ||
        data?.choices?.[0]?.text ||
        null;

      if (!res.ok) {
        bubble({ html: md(`**Error ${res.status}** — ${reply || data?.error || 'Auth or CORS issue? Make sure the ANON key is valid.'}`) });
        return;
      }

      if (!reply) {
        bubble({ html: md("I’m having trouble reading the server response. Please try again.") });
        return;
      }

      bubble({ html: md(reply) });
      history.push({ role: "assistant", content: reply });

    }catch(e){
      typing(false);
      bubble({ html: md("Network hiccup. Try again, or ask something like **“Top skills for cloud engineer in 2025?”**") });
      console.error(e);
    }finally{
      busy = false; send.disabled = false;
    }
  }
</script>

</body>
</html>
