<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>CareerWise — Assessment</title>

  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
  <style>
    :root{
      --bg:#ffffff; --surface:#ffffff; --border:#e5e7eb;
      --text:#0f172a; --muted:#6b7280;
      --primary:#3165ff; --primary-600:#2656f5; --success:#22c55e;
      --radius:14px; --shadow:0 10px 30px rgba(15,23,42,.06);
    }
    *{box-sizing:border-box} html,body{height:100%}
    body{margin:0;background:var(--bg);color:var(--text);font-family:"Inter",system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif}
    .container{max-width:1080px;margin:0 auto;padding:24px}
    .topbar{display:flex;align-items:center;justify-content:space-between;margin-bottom:8px}
    .brand{display:flex;align-items:center;gap:12px}
    .logo{width:36px;height:36px;border-radius:10px;background:linear-gradient(135deg,#7aa2ff 0%, #5a6bff 35%, #6a57ff 100%);box-shadow:var(--shadow)}
    .chip{font-size:12px;color:#475569;border:1px solid var(--border);padding:6px 10px;border-radius:999px;background:var(--surface)}
    .btn{display:inline-flex;align-items:center;justify-content:center;padding:10px 12px;border-radius:12px;border:1px solid var(--border);cursor:pointer;background:#fff;font-weight:600}
    .btn.primary{background:var(--primary);border-color:transparent;color:#fff}
    .btn.primary:hover{background:var(--primary-600)}
    .badge{width:28px;height:28px;border-radius:8px;background:#eef2ff;color:#1d4ed8;display:grid;place-items:center;font-weight:800}
    .muted{color:var(--muted)} .hidden{display:none!important}
    .card{background:var(--surface);border:1px solid var(--border);border-radius:var(--radius);box-shadow:var(--shadow);padding:22px}
    .inline{display:flex;align-items:center;gap:10px}
    .q{border:1px solid var(--border);border-radius:12px;padding:14px;background:#fff}
    .rate{display:flex;gap:8px;margin-top:8px}
    .rate button{width:38px;height:38px;border-radius:12px;border:1px solid var(--border);background:#fff;font-weight:700;cursor:pointer}
    .rate button.is-on{background:#e3edff;border-color:#c7d2fe;color:#1d4ed8}
    .chips{display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:10px}
    .chip-row{display:flex;align-items:center;justify-content:space-between;border:1px solid var(--border);border-radius:12px;padding:10px 12px;background:#fff}
    .grid-2{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    @media (max-width:700px){.grid-2{grid-template-columns:1fr}}
    .match{border:1px solid var(--border);border-radius:16px;padding:16px;background:#fff}
    .match .hdr{display:flex;align-items:center;justify-content:space-between}
    .badge-pill{font-size:12px;padding:6px 10px;border-radius:999px;background:#eef2ff;color:#1d4ed8;border:1px solid #c7d2fe}
  </style>
</head>
<body>
  <div class="container">
    <div class="topbar">
      <div class="brand"><div class="logo"></div><strong>CareerWise</strong></div>
      <div class="inline">
        <span class="chip">API: <strong id="api">https://careerwise-api.onrender.com</strong></span>
        <span id="who" class="muted"></span>
        <span id="badge" class="badge">U</span>
        <button id="signOutBtn" class="btn">Sign out</button>
      </div>
    </div>

    <!-- App -->
    <section class="card" aria-label="Psychometric Analysis">
      <div class="topbar" style="margin-bottom:8px">
        <h3 style="margin:0">Psychometric Analysis</h3>
        <div class="inline">
          <button id="btnReloadApi" class="btn" type="button">Reload from API</button>
          <button id="btnLoadDemo" class="btn" type="button">Load Demo Questions</button>
        </div>
      </div>
      <p class="muted">Answer quickly on a 1–5 scale.</p>

      <div id="questions" class="inline" style="flex-direction:column;gap:10px;margin-top:12px"></div>

      <div class="grid-2" style="margin-top:12px;">
        <input id="skills" class="btn" style="text-align:left" placeholder="Skills (comma separated)" value="sql, excel" />
        <input id="interests" class="btn" style="text-align:left" placeholder="Interests (comma separated)" value="data, analytics" />
      </div>

      <div class="inline" style="margin-top:12px">
        <button id="analyzeBtn" class="btn primary" type="button">Run Analysis</button>
        <span id="pErr" class="muted hidden"></span>
      </div>

      <div id="analysis" class="hidden" style="margin-top:16px;">
        <div class="card" style="background:#f6f7f9">
          <h4 style="margin:0 0 6px">Summary</h4>
          <p id="summary" class="muted" style="white-space:pre-wrap;margin:0"></p>

          <h4 style="margin:14px 0 6px">Traits</h4>
          <div id="traits" class="chips"></div>

          <h4 style="margin:14px 0 6px">Cautions</h4>
          <ul id="cautions" style="margin:0 0 0 18px;color:#111827"></ul>
        </div>
      </div>
    </section>

    <section class="card" aria-label="Career Match" style="margin-top:18px">
      <h3 style="margin-top:0">Career Match</h3>
      <p class="muted">Uses traits, skills, and interests above.</p>
      <div class="inline" style="margin-top:8px">
        <button id="matchBtn" class="btn primary" type="button">Get Matches</button>
        <span id="mErr" class="muted hidden"></span>
      </div>
      <div id="matches" class="inline" style="flex-direction:column;gap:12px;margin-top:14px"></div>
    </section>
  </div>

  <script type="module">
    import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/+esm";
    const SUPABASE_URL = "https://awsuhluvyrxwmogzyfhr.supabase.co";
    const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImF3c3VobHV2eXJ4d21vZ3p5ZmhyIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTcwNTI5NzksImV4cCI6MjA3MjYyODk3OX0.L_Ye8GAeC61xiW67a_bCTP5Wr7UtRja7o4_Y6mDwaLE";
    const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    // gatekeeping: must be user or guest
    async function requireAuth() {
      const { data:{session} } = await supabase.auth.getSession();
      const guest = localStorage.getItem("cw_guest_id");
      if (session) {
        setupUser(session.user.email, false);
        return;
      }
      if (guest) {
        setupUser(`Guest: ${guest.replace("guest_","G-")}`, true);
        return;
      }
      location.href = "index.html";
    }

    // header identity + sign out
    function setupUser(label, isGuest){
      document.getElementById('who').textContent = label;
      document.getElementById('badge').textContent = (label||'U').slice(0,1).toUpperCase();
      document.getElementById('signOutBtn').onclick = async ()=>{
        await supabase.auth.signOut().catch(()=>{});
        localStorage.removeItem("cw_guest_id");
        location.href = "index.html";
      };
    }

    await requireAuth();

    // -------- App logic (same as before) --------
   <!-- ===================== APP LOGIC (Supabase-direct, no Render API) ===================== -->
<script>
(function(){
  // Require the Supabase client exposed by your module script
  if (!window.__sb) {
    console.warn('Supabase client not found. After createClient(...), add: window.__sb = supabase;');
  }
  const sb = () => window.__sb;

  // Update API chip to show we're using Supabase directly
  const apiChip = document.getElementById('api');
  const apiStatus = document.getElementById('apiStatus'); // present on your index; safe if null here
  if (apiChip) apiChip.textContent = 'Supabase Direct';
  if (apiStatus) { apiStatus.textContent = 'online'; }

  // Demo fallback questions (if DB is empty)
  const demoQuestions = [
    { id: 'q1', text: 'I enjoy solving complex problems.', weights: {"Analytical":0.8,"Persistence":0.3} },
    { id: 'q2', text: 'I communicate my ideas clearly.',   weights: {"Communication":0.9} },
    { id: 'q3', text: 'I like experimenting with new ideas.', weights: {"Creativity":0.8,"Adaptability":0.2} },
    { id: 'q4', text: 'I stay focused until tasks are complete.', weights: {"Persistence":0.9} },
    { id: 'q5', text: 'I collaborate well in teams.', weights: {"Collaboration":0.9} },
  ];

  // UI handles
  const questionsEl = document.getElementById('questions');
  const pErr = document.getElementById('pErr');
  const mErr = document.getElementById('mErr');

  // Local persistence of answers
  const LS_KEY = "cw_answers_v1";
  function saveAnswersLocal(answers){ try{ localStorage.setItem(LS_KEY, JSON.stringify(answers)); }catch{} }
  function readAnswersLocal(){ try{ return JSON.parse(localStorage.getItem(LS_KEY) || "[]"); }catch{ return []; } }

  // Render question list
  function renderQuestions(list){
    questionsEl.innerHTML = '';
    const saved = new Map(readAnswersLocal().map(a=>[a.id, a.value]));
    list.forEach((q, idx) => {
      const selected = saved.get(q.id) || 0;
      const row = document.createElement('div');
      row.className = 'q';
      row.innerHTML = `
        <div style="font-weight:600">${idx+1}. ${q.text}</div>
        <div class="rate" role="radiogroup" aria-label="Rating for ${q.text}"
             data-qid="${q.id}" data-weights='${JSON.stringify(q.weights||{})}'>
          ${[1,2,3,4,5].map(v => `<button type="button" aria-pressed="${selected===v}" data-v="${v}" class="${selected===v?'is-on':''}">${v}</button>`).join('')}
        </div>
      `;
      questionsEl.appendChild(row);
    });
  }

  // Click-to-rate
  questionsEl.addEventListener('click', (e) => {
    const btn = e.target.closest('button[data-v]');
    if (!btn) return;
    const group = btn.parentElement;
    group.querySelectorAll('button').forEach(b => { b.classList.remove('is-on'); b.setAttribute('aria-pressed','false'); });
    btn.classList.add('is-on'); btn.setAttribute('aria-pressed','true');
    group.setAttribute('data-selected', btn.getAttribute('data-v'));
    saveAnswersLocal(readAnswers());
  });

  // Collect answers (default 3 when not answered)
  function readAnswers(){
    const rows = questionsEl.querySelectorAll('div.rate[data-qid]');
    const answers = [];
    const ids = new Set();
    rows.forEach(row => {
      const id = row.getAttribute('data-qid');
      const v  = Number(row.getAttribute('data-selected') || 0);
      if (v) { answers.push({ id, value: v }); ids.add(id); }
    });
    rows.forEach(row => {
      const id = row.getAttribute('data-qid');
      if (!ids.has(id)) answers.push({ id, value: 3 });
    });
    return answers;
  }

  // Load questions directly from Supabase (public.questions where active=true)
  async function loadQuestionsFromSupabase(){
    try{
      const { data, error } = await sb()
        .from('questions')
        .select('id,text,weights,active')
        .eq('active', true)
        .order('id', { ascending: true });
      if (error) throw error;
      const list = (data && data.length) ? data : demoQuestions;
      renderQuestions(list);
    }catch(err){
      console.error('Questions load error', err);
      renderQuestions(demoQuestions);
    }
  }

  // Local analysis using per-question weights (0..100 scores)
  function analyzeLocally(){
    const rows = questionsEl.querySelectorAll('div.rate[data-qid]');
    const agg = {}; // trait -> {sum, wsum}
    rows.forEach(row=>{
      const sel = Number(row.getAttribute('data-selected') || 3);      // 1..5
      const z   = (sel - 3) / 2;                                       // -1..+1
      const weights = JSON.parse(row.getAttribute('data-weights')||'{}');
      Object.entries(weights).forEach(([trait, w])=>{
        if (!agg[trait]) agg[trait] = { sum:0, wsum:0 };
        agg[trait].sum  += z * Number(w);
        agg[trait].wsum += Math.abs(Number(w));
      });
    });
    const traits = Object.entries(agg).map(([name, v])=>{
      const z = v.wsum ? (v.sum / v.wsum) : 0;   // -1..+1
      return { name, score: Math.round(50 + z*50) };
    }).sort((a,b)=>b.score-a.score);

    const summary  = traits.length
      ? `Top strengths: ${traits.slice(0,3).map(t=>t.name).join(', ')}`
      : 'Answer a few questions to see your strengths.';
    const cautions = traits.filter(t=>t.score < 45).map(t=>`Consider developing ${t.name.toLowerCase()}.`);

    return { summary, traits, cautions };
  }

  // Local matching against public.careers(traits jsonb)
  async function getMatchesLocally(topK = 5){
    const { data, error } = await sb()
      .from('careers')
      .select('id,title,traits,description');
    if (error) throw error;

    const analysis = analyzeLocally();
    const u = {}; analysis.traits.forEach(t=>{ u[t.name]=t.score/100; });

    function sim(a,b){
      const keys = new Set([...Object.keys(a), ...Object.keys(b)]);
      let dot=0, na=0, nb=0;
      keys.forEach(k=>{ const x=a[k]||0, y=b[k]||0; dot+=x*y; na+=x*x; nb+=y*y; });
      const d = Math.sqrt(na)*Math.sqrt(nb) || 1;
      return dot/d;
    }

    return (data||[])
      .map(c=>{
        const ct = {}; Object.entries(c.traits||{}).forEach(([k,v])=>{ ct[k]=Number(v)||0; });
        const s  = Math.round(Math.max(0, Math.min(1, sim(u, ct))) * 100);
        return { ...c, score: s };
      })
      .sort((a,b)=>b.score-a.score)
      .slice(0, topK);
  }

  // Hook up buttons
  document.getElementById('btnLoadDemo')?.addEventListener('click', () => renderQuestions(demoQuestions));
  document.getElementById('btnReloadApi')?.addEventListener('click', loadQuestionsFromSupabase);

  document.getElementById('analyzeBtn')?.addEventListener('click', ()=>{
    pErr?.classList.add('hidden');
    try{
      const res = analyzeLocally();
      document.getElementById('summary').textContent = res.summary;

      const traitsEl = document.getElementById('traits');
      traitsEl.innerHTML = '';
      res.traits.forEach(t=>{
        const row = document.createElement('div');
        row.className = 'chip-row';
        row.innerHTML = `<span>${t.name}</span><span class="muted">${t.score}/100</span>`;
        traitsEl.appendChild(row);
      });

      const cautionsEl = document.getElementById('cautions');
      cautionsEl.innerHTML = '';
      res.cautions.forEach(c=>{
        const li = document.createElement('li');
        li.textContent = c;
        cautionsEl.appendChild(li);
      });

      document.getElementById('analysis').classList.remove('hidden');
    }catch(err){
      if (pErr){ pErr.textContent = err.message || 'Analyze error'; pErr.classList.remove('hidden'); }
    }
  });

  document.getElementById('matchBtn')?.addEventListener('click', async ()=>{
    mErr?.classList.add('hidden');
    try{
      const wrap = document.getElementById('matches');
      wrap.innerHTML = 'Loading…';

      const results = await getMatchesLocally(5);
      wrap.innerHTML = '';
      results.forEach(item=>{
        const card = document.createElement('div');
        card.className = 'match';
        card.innerHTML = `
          <div class="hdr">
            <div style="font-weight:700">${item.title}</div>
            <span class="badge-pill">${item.score}% fit</span>
          </div>
          <p class="muted" style="margin:6px 0 0; white-space:pre-wrap;">${item.description || ''}</p>
        `;
        wrap.appendChild(card);
      });
    }catch(err){
      if (mErr){ mErr.textContent = err.message || 'Match error'; mErr.classList.remove('hidden'); }
    }
  });

  // Initial load
  loadQuestionsFromSupabase();
})();
</script>

</body>
</html>
