<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>CareerWise ‚Äî Mock Interview (Voice)</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
  <style>
    :root{
      --bg:#f6f8fc; --surface:#ffffff; --text:#0f172a; --muted:#64748b;
      --border:#e5e7eb; --primary:#3165ff; --primary-600:#2452ef; --danger:#ef4444;
      --radius:12px; --shadow:0 10px 30px rgba(2,6,23,.06);
    }
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);color:var(--text);font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif}
    .wrap{max-width:980px;margin:0 auto;padding:28px}
    .top{display:flex;align-items:center;justify-content:space-between;margin-bottom:16px}
    .brand{display:flex;align-items:center;gap:12px}
    .logo{width:36px;height:36px;border-radius:10px;background:linear-gradient(135deg,#7aa2ff 0%, #5a6bff 35%, #6a57ff 100%);box-shadow:var(--shadow)}
    .btn{display:inline-flex;align-items:center;gap:8px;padding:10px 12px;border:1px solid var(--border);border-radius:10px;background:#fff;font-weight:600;cursor:pointer}
    .btn:hover{border-color:#d1d5db}
    .primary{padding:12px 16px;border-radius:12px;border:1px solid var(--primary);background:var(--primary);color:#fff;font-weight:700;cursor:pointer}
    .primary:disabled{opacity:.6;cursor:not-allowed}
    .primary.danger{border-color:var(--danger);background:var(--danger)}
    .card{background:var(--surface);border:1px solid var(--border);border-radius:16px;box-shadow:var(--shadow);padding:18px}
    .muted{color:var(--muted)}
    .row{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
    .input{padding:10px 12px;border:1px solid var(--border);border-radius:10px;background:#fff}
    .block{border:1px solid var(--border);border-left:3px solid var(--primary);border-radius:10px;background:#fff;padding:12px}
    .title{font-weight:700;margin:0 0 6px}
    .stack{display:grid;gap:10px}
    .score{display:flex;gap:8px;flex-wrap:wrap}
    .chip{border:1px solid var(--border);border-radius:999px;padding:6px 10px;background:#fff;color:#111827;font-size:12px}

    /* Control bar */
    .controls{display:flex;gap:12px;align-items:center;flex-wrap:wrap}
    .control{display:flex;flex-direction:column;gap:4px}
    .label{font-size:12px;color:var(--muted);font-weight:600}
    .select{padding:10px 12px;border:1px solid var(--border);border-radius:10px;background:#fff;min-width:84px}

    /* Switch */
    .switch{display:flex;align-items:center;gap:10px}
    .sw{position:relative;display:inline-block;width:44px;height:24px}
    .sw input{opacity:0;width:0;height:0}
    .slider{position:absolute;cursor:pointer;inset:0;background:#e5e7eb;border-radius:999px;transition:.2s}
    .slider:before{content:"";position:absolute;height:18px;width:18px;left:3px;top:3px;background:#fff;border-radius:50%;transition:.2s;box-shadow:0 1px 2px rgba(0,0,0,.15)}
    .sw input:checked + .slider{background:#c7d2fe}
    .sw input:checked + .slider:before{transform:translateX(20px)}
    .switch span{font-size:12px;color:var(--muted);font-weight:600}

    /* Toolbar */
    .toolbar{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
    .icon-btn{display:inline-flex;align-items:center;gap:6px;padding:10px 12px;border:1px solid var(--border);border-radius:10px;background:#fff;cursor:pointer;font-weight:600;color:#111827}
    .icon-btn[disabled]{opacity:.5;cursor:not-allowed}
    .hint{color:var(--muted);font-size:13px}
    .warn{color:#b91c1c}
    @media (max-width:640px){ .primary{width:100%} .controls{gap:8px} }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="top">
      <div class="brand"><div class="logo"></div><strong>CareerWise</strong></div>
      <a class="btn" href="dashboard.html">‚Üê Back</a>
    </div>

    <!-- Setup -->
    <section class="card">
      <h2 style="margin:0 0 6px">Mock Interview (Voice)</h2>
      <p class="muted" style="margin:0 0 10px">We‚Äôll ask one question at a time. You‚Äôll answer by voice. You‚Äôll get instant coaching and a final report.</p>

      <div class="controls" style="margin-top:6px">
        <div class="control" style="min-width:260px">
          <div class="label">Role</div>
          <input id="role" class="input" placeholder="Role (e.g., Data Scientist)" />
        </div>

        <div class="control">
          <div class="label">Questions</div>
          <select id="count" class="select"><option>5</option><option selected>6</option><option>7</option><option>8</option></select>
        </div>

        <div class="control">
          <div class="label">Speak questions</div>
          <label class="switch">
            <label class="sw">
              <input id="speak" type="checkbox" checked />
              <span class="slider"></span>
            </label>
            <span id="speakLabel">On</span>
          </label>
        </div>

        <button id="start" class="primary">Start Interview</button>
      </div>

      <p id="setupErr" class="muted warn" style="margin:6px 0 0;display:none"></p>
    </section>

    <!-- Live interview -->
    <section class="card" style="margin-top:14px">
      <div class="row" style="justify-content:space-between">
        <div>
          <div class="title">Question <span id="qNum">0</span>/<span id="qMax">0</span></div>
          <div id="question" class="block" style="min-height:64px"></div>
        </div>
        <div>
          <div class="title">Timer <span class="muted" style="font-weight:600">(ideal: 60‚Äì90s)</span></div>
          <div id="timer" class="block" style="min-width:120px;text-align:center;font-weight:700">00:00</div>
        </div>
      </div>

      <div class="toolbar" style="margin-top:10px">
        <button id="recBtn" class="primary" disabled>üéôÔ∏è Hold to answer</button>
        <button id="stopBtn" class="icon-btn" style="display:none">‚ñ† Stop</button>
        <button id="redoBtn" class="icon-btn" title="Redo current question" disabled>‚Ü∫ Redo</button>
        <button id="skipBtn" class="icon-btn" title="Skip question" disabled>‚§º Skip</button>
        <span id="recHint" class="hint">Press and speak for ~60‚Äì90s. Release to send.</span>
      </div>

      <div id="turnOut" class="stack" style="margin-top:12px;display:none">
        <div class="block">
          <div class="title">Transcript</div>
          <div id="transcript" class="muted"></div>
        </div>
        <div class="block">
          <div class="title">Evaluation</div>
          <div id="scores" class="score"></div>
          <div id="positives" class="muted" style="margin-top:6px"></div>
          <div id="gaps" class="muted" style="margin-top:6px"></div>
          <div id="coaching" style="margin-top:6px"></div>
        </div>
        <div class="block">
          <div class="title">Sample answer</div>
          <div id="sample"></div>
        </div>
      </div>

      <div id="finished" class="stack" style="margin-top:12px;display:none">
        <div class="block">
          <div class="title">Report</div>
          <div id="report"></div>
        </div>
        <div class="row">
          <button id="dlPdf" class="btn">Download PDF</button>
          <button id="restart" class="btn">Restart</button>
        </div>
      </div>
    </section>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>

  <script type="module">
    // ====== CONFIG ======
    const FN = "https://awsuhluvyrxwmogzyfhr.supabase.co/functions/v1/interview-voice";
    const ANON = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImF3c3VobHV2eXJ4d21vZ3p5ZmhyIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTcwNTI5NzksImV4cCI6MjA3MjYyODk3OX0.L_Ye8GAeC61xiW67a_bCTP5Wr7UtRja7o4_Y6mDwaLE";

    // ====== ELs ======
    const roleIn = document.getElementById('role');
    const countSel = document.getElementById('count');
    const speakChk = document.getElementById('speak');
    const speakLabel = document.getElementById('speakLabel');
    const startBtn = document.getElementById('start');
    const setupErr = document.getElementById('setupErr');

    const qNum = document.getElementById('qNum');
    const qMax = document.getElementById('qMax');
    const questionEl = document.getElementById('question');
    const timerEl = document.getElementById('timer');

    const recBtn = document.getElementById('recBtn');
    const stopBtn = document.getElementById('stopBtn');
    const redoBtn = document.getElementById('redoBtn');
    const skipBtn = document.getElementById('skipBtn');
    const recHint = document.getElementById('recHint');

    const turnOut = document.getElementById('turnOut');
    const transcriptEl = document.getElementById('transcript');
    const scoresEl = document.getElementById('scores');
    const positivesEl = document.getElementById('positives');
    const gapsEl = document.getElementById('gaps');
    const coachingEl = document.getElementById('coaching');
    const sampleEl = document.getElementById('sample');

    const finished = document.getElementById('finished');
    const reportEl = document.getElementById('report');
    const dlPdf = document.getElementById('dlPdf');
    const restart = document.getElementById('restart');

    // ====== STATE ======
    let role = "";
    let maxQ = 6;
    let qIndex = 0;
    let currentQ = "";
    let runningSummary = "";
    let speakingOn = true;

    // timer
    let tStart = 0, tId = 0;
    function startTimer() {
      tStart = Date.now();
      clearInterval(tId);
      tId = setInterval(()=>{
        const s = Math.floor((Date.now() - tStart)/1000);
        const m = String(Math.floor(s/60)).padStart(2,'0');
        const r = String(s%60).padStart(2,'0');
        timerEl.textContent = `${m}:${r}`;
      }, 250);
    }
    function stopTimer(){ clearInterval(tId); }

    // TTS
    function speak(text) {
      if (!speakingOn) return;
      try {
        speechSynthesis.cancel();
        const u = new SpeechSynthesisUtterance(text);
        u.rate = 1; u.pitch = 1; u.lang = "en-US";
        speechSynthesis.speak(u);
      } catch {}
    }

    // Recording
    let media, rec, chunks = [];
    async function startRec() {
      media = await navigator.mediaDevices.getUserMedia({ audio: true });
      rec = new MediaRecorder(media, { mimeType: "audio/webm" });
      chunks = [];
      rec.ondataavailable = (e)=> e.data && chunks.push(e.data);
      rec.start();

      recBtn.classList.add('danger');
      recBtn.textContent = "‚óè Recording‚Ä¶ release to send";
      stopBtn.style.display = '';
      redoBtn.disabled = true;
      skipBtn.disabled = true;
      recHint.textContent = "Recording‚Ä¶ keep it concise and structured.";
      startTimer();
    }
    async function stopRecAndSend() {
      if (!rec) return;
      await new Promise(r => { rec.onstop = r; rec.stop(); });
      media.getTracks().forEach(t => t.stop());

      recBtn.classList.remove('danger');
      recBtn.textContent = "üéôÔ∏è Hold to answer";
      stopBtn.style.display = 'none';
      redoBtn.disabled = false;
      skipBtn.disabled = false;

      recHint.textContent = "Processing answer‚Ä¶";
      stopTimer();

      const blob = new Blob(chunks, { type: "audio/webm" });
      await sendTurnWithFallback(blob);
    }

    // UI helpers
    function renderQuestion(q) {
      questionEl.textContent = q;
      turnOut.style.display = 'none';
      transcriptEl.textContent = '';
      scoresEl.innerHTML = '';
      positivesEl.textContent = '';
      gapsEl.textContent = '';
      coachingEl.textContent = '';
      sampleEl.textContent = '';

      recHint.textContent = "Press and speak for ~60‚Äì90s. Release to send.";
      recBtn.disabled = false;
      redoBtn.disabled = true;
      skipBtn.disabled = false;
      stopBtn.style.display = 'none';
      startTimer();
    }
    function renderEval(transcript, ev) {
      turnOut.style.display = 'grid';
      transcriptEl.textContent = transcript || "(no speech detected)";
      scoresEl.innerHTML = '';
      const scores = ev?.scores || {};
      Object.keys(scores).forEach(k=>{
        const b = document.createElement('span');
        b.className = 'chip';
        b.textContent = `${k}: ${scores[k]}/5`;
        scoresEl.appendChild(b);
      });
      positivesEl.textContent = ev?.positives?.length ? `üëç ${ev.positives.join(" ‚Ä¢ ")}` : "";
      gapsEl.textContent = ev?.gaps?.length ? `‚ö†Ô∏è ${ev.gaps.join(" ‚Ä¢ ")}` : "";
      coachingEl.textContent = ev?.coaching || "";
      sampleEl.textContent = ev?.sample_answer || "";
    }

    // Calls
    async function startInterview() {
      setupErr.style.display = 'none';
      role = (roleIn.value || '').trim();
      if (!role){ setupErr.textContent = "Please enter a role."; setupErr.style.display='block'; return; }

      speakingOn = speakChk.checked === true;
      speakLabel.textContent = speakingOn ? 'On' : 'Off';
      maxQ = Number(countSel.value || 6);

      const res = await fetch(FN, {
        method: "POST",
        headers: { "Content-Type": "application/json", "Authorization": `Bearer ${ANON}` },
        body: JSON.stringify({ step: "start", role, count: maxQ })
      });
      const data = await res.json();
      if (!data.ok) { setupErr.textContent = data.error || 'Start failed'; setupErr.style.display='block'; return; }

      qIndex = 0;
      currentQ = data.question;
      runningSummary = data.summary || "";
      qMax.textContent = data.maxQuestions;
      qNum.textContent = String(qIndex + 1);

      if (speakingOn) speak(currentQ);
      renderQuestion(currentQ);
      recBtn.focus();
    }

    // Robust sender: try (1) audio field "audio" ‚Üí (2) "file" ‚Üí (3) JSON base64
    async function sendTurnWithFallback(blob){
      // 1) multipart with "audio"
      let r = await sendTurnMultipart(blob, "audio");
      if (r.ok) return handleTurnOK(r.data);

      // 2) multipart with "file"
      r = await sendTurnMultipart(blob, "file");
      if (r.ok) return handleTurnOK(r.data);

      // 3) JSON base64
      const b64 = await blobToBase64(blob);
      r = await sendTurnJSON(b64);
      if (r.ok) return handleTurnOK(r.data);

      recHint.textContent = r.error || "Send failed (check mic permission or try again).";
    }

    async function sendTurnMultipart(blob, fieldName){
      try{
        const form = new FormData();
        form.append("step", "turn");
        form.append("role", role);
        form.append("q_index", String(qIndex));
        form.append("max_questions", String(maxQ));
        form.append("question", currentQ);
        form.append("running_summary", runningSummary);
        if (blob) form.append(fieldName, blob, "answer.webm");

        const res = await fetch(FN, { method:"POST", headers:{ "Authorization": `Bearer ${ANON}` }, body: form });
        const data = await res.json().catch(()=> ({}));
        return { ok: res.ok && data?.ok, data, error: data?.error || (!res.ok && `HTTP ${res.status}`) };
      }catch(e){ return { ok:false, error:String(e) }; }
    }

    async function sendTurnJSON(b64){
      try{
        const res = await fetch(FN, {
          method:"POST",
          headers:{ "Authorization": `Bearer ${ANON}`, "Content-Type":"application/json" },
          body: JSON.stringify({
            step:"turn_b64",
            role, q_index:qIndex, max_questions:maxQ,
            question: currentQ, running_summary: runningSummary,
            audio_b64: b64
          })
        });
        const data = await res.json().catch(()=> ({}));
        return { ok: res.ok && data?.ok, data, error: data?.error || (!res.ok && `HTTP ${res.status}`) };
      }catch(e){ return { ok:false, error:String(e) }; }
    }

    function handleTurnOK(data){
      renderEval(data.transcript, data.eval);
      runningSummary = data.updated_summary || runningSummary;

      const nextQ = data.next?.question;
      if (nextQ) {
        qIndex += 1;
        qNum.textContent = String(qIndex + 1);
        currentQ = nextQ;
        if (speakingOn) speak(currentQ);
        renderQuestion(currentQ);
      } else {
        stopTimer();
        fetchReport();
      }
    }

    // Skip support (works even if the function doesn‚Äôt accept empty audio)
    skipBtn.onclick = async ()=>{
      recHint.textContent = "Skipping‚Ä¶";
      const res = await fetch(FN, {
        method:"POST",
        headers:{ "Authorization": `Bearer ${ANON}`, "Content-Type":"application/json" },
        body: JSON.stringify({
          step:"skip",
          role, q_index:qIndex, max_questions:maxQ,
          question: currentQ, running_summary: runningSummary
        })
      });
      let data = {};
      try{ data = await res.json(); }catch{}
      if (res.ok && data?.ok && data?.next?.question){
        qIndex += 1;
        qNum.textContent = String(qIndex + 1);
        currentQ = data.next.question;
        if (speakingOn) speak(currentQ);
        renderQuestion(currentQ);
        recHint.textContent = "Skipped. Answer the next one.";
      } else {
        // Fallback: ask backend for next even if it doesn‚Äôt support skip explicitly
        const fake = await fetch(FN, {
          method:"POST",
          headers:{ "Authorization": `Bearer ${ANON}` },
          body: new FormData(Object.assign(new FormData(), { append(){} }))
        }).catch(()=>null);
        recHint.textContent = "Unable to skip (server). Try answering briefly or refresh.";
      }
    };

    async function fetchReport() {
      const res = await fetch(FN, {
        method: "POST",
        headers: { "Content-Type": "application/json", "Authorization": `Bearer ${ANON}` },
        body: JSON.stringify({ step: "report", role, running_summary: runningSummary })
      });
      const data = await res.json().catch(()=> ({}));
      finished.style.display = 'grid';
      const r = data.report || {};
      reportEl.innerHTML = `
        <div class="muted"><strong>Overall:</strong> ${r.overall_signal || '‚Äî'}</div>
        <div style="margin-top:6px">${r.summary || ''}</div>
        ${Array.isArray(r.strengths) ? `<div style="margin-top:6px"><strong>Strengths:</strong> ${r.strengths.join(" ‚Ä¢ ")}</div>` : ""}
        ${Array.isArray(r.improvements) ? `<div style="margin-top:6px"><strong>Improvements:</strong> ${r.improvements.join(" ‚Ä¢ ")}</div>` : ""}
        ${Array.isArray(r.next_steps) ? `<div style="margin-top:6px"><strong>Next steps:</strong> ${r.next_steps.join(" ‚Ä¢ ")}</div>` : ""}
      `;
    }

    // PDF
    dlPdf.onclick = ()=>{
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF({ unit: "pt", format: "a4" });
      const title = `CareerWise Mock Interview ‚Äî ${role || 'Role'}`;
      doc.setFont("helvetica","bold"); doc.setFontSize(14); doc.text(title, 40, 40);
      doc.setFont("helvetica",""); doc.setFontSize(11);
      const text = (reportEl.innerText || "").split("\n");
      let y = 70;
      text.forEach(line => { doc.text(line, 40, y); y += 16; if (y > 780){ doc.addPage(); y = 40; }});
      const fname = `mock-interview_${(role||'role').replace(/\s+/g,'-').toLowerCase()}.pdf`;
      doc.save(fname);
    };

    restart.onclick = ()=> location.reload();

    // Start
    startBtn.onclick = startInterview;
    speakChk.onchange = ()=> { speakLabel.textContent = speakChk.checked ? 'On' : 'Off'; speakingOn = speakChk.checked; };

    // Pointer-based hold-to-answer (reliable)
    recBtn.addEventListener('pointerdown', (e)=>{ e.preventDefault(); startRec(); recBtn.setPointerCapture(e.pointerId); });
    const stopFromPointer = (e)=>{ if (rec) { stopRecAndSend(); recBtn.releasePointerCapture?.(e.pointerId); } };
    recBtn.addEventListener('pointerup', stopFromPointer);
    recBtn.addEventListener('pointercancel', stopFromPointer);
    recBtn.addEventListener('pointerleave', stopFromPointer);

    // Redo = re-ask the same question
    redoBtn.onclick = ()=>{ if (currentQ) { if (speakingOn) speak(currentQ); renderQuestion(currentQ); } };

    // No default role text
    roleIn.value = "";
  </script>
</body>
</html>
