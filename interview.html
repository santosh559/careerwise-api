<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>CareerWise ‚Äî Mock Interview (Voice)</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
  <style>
    :root{
      --bg:#f7f8fb; --surface:#ffffff; --text:#0f172a; --muted:#6b7280;
      --border:#e5e7eb; --primary:#3165ff; --primary-600:#2452ef;
      --radius:12px; --shadow:0 10px 30px rgba(15,23,42,.06);
    }
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);color:var(--text);font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif}
    .wrap{max-width:980px;margin:0 auto;padding:28px}
    .top{display:flex;align-items:center;justify-content:space-between;margin-bottom:16px}
    .brand{display:flex;align-items:center;gap:12px}
    .logo{width:36px;height:36px;border-radius:10px;background:linear-gradient(135deg,#7aa2ff 0%, #5a6bff 35%, #6a57ff 100%);box-shadow:var(--shadow)}
    .btn{display:inline-flex;align-items:center;gap:8px;padding:10px 12px;border:1px solid var(--border);border-radius:10px;background:#fff;font-weight:600;cursor:pointer}
    .btn:hover{border-color:#d1d5db}
    .primary{padding:10px 14px;border-radius:10px;border:1px solid var(--primary);background:var(--primary);color:#fff;font-weight:700;cursor:pointer}
    .primary:disabled{opacity:.6;cursor:not-allowed}
    .card{background:var(--surface);border:1px solid var(--border);border-radius:16px;box-shadow:var(--shadow);padding:18px}
    .muted{color:var(--muted)}
    .row{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
    .input,select{padding:10px 12px;border:1px solid var(--border);border-radius:10px;background:#fff}
    .stack{display:grid;gap:10px}
    .block{border:1px solid var(--border);border-left:3px solid var(--primary);border-radius:10px;background:#fff;padding:12px}
    .title{font-weight:700;margin:0 0 6px}
    .score{display:flex;gap:8px;flex-wrap:wrap}
    .chip{border:1px solid var(--border);border-radius:999px;padding:6px 10px;background:#fff;color:#111827;font-size:12px}
    .warn{color:#b91c1c}
    .ok{color:#15803d}
    .sep{height:1px;background:#eef2f7;margin:8px 0}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="top">
      <div class="brand"><div class="logo"></div><strong>CareerWise</strong></div>
      <a class="btn" href="dashboard.html">‚Üê Back</a>
    </div>

    <!-- Setup -->
    <section class="card">
      <h2 style="margin:0 0 6px">Mock Interview (Voice)</h2>
      <p class="muted" style="margin:0 0 10px">We‚Äôll ask one question at a time. You‚Äôll answer by voice. You‚Äôll get instant coaching and a final report.</p>
      <div class="row" style="margin-top:8px">
        <input id="role" class="input" placeholder="Role (e.g., Data Scientist)" style="min-width:240px" />
        <label>Questions
          <select id="count" class="input">
            <option>5</option><option selected>6</option><option>7</option><option>8</option>
          </select>
        </label>
        <label>Speak questions
          <select id="speak" class="input"><option selected>On</option><option>Off</option></select>
        </label>
        <button id="start" class="primary">Start Interview</button>
      </div>
      <p id="setupErr" class="muted warn" style="margin:6px 0 0;display:none"></p>
    </section>

    <!-- Live interview -->
    <section class="card" style="margin-top:14px">
      <div class="row" style="justify-content:space-between">
        <div>
          <div class="title">Question <span id="qNum">0</span>/<span id="qMax">0</span></div>
          <div id="question" class="block" style="min-height:64px"></div>
        </div>
        <div>
          <div class="title">Timer <span class="muted" style="font-weight:400">(ideal: 60‚Äì90s)</span></div>
          <div id="timer" class="block" style="min-width:120px;text-align:center;font-weight:700">00:00</div>
          <div class="row" style="margin-top:6px">
            <button id="pauseBtn" class="btn" disabled>Pause</button>
            <button id="resumeBtn" class="btn" disabled>Resume</button>
          </div>
        </div>
      </div>

      <div class="row" style="margin-top:10px">
        <button id="recBtn" class="primary" disabled>üéôÔ∏è Hold to Answer</button>
        <button id="stopBtn" class="btn" disabled>Stop</button>
        <button id="redoBtn" class="btn" disabled>Redo (1)</button>
        <button id="sendBtn" class="btn" disabled>Send Answer</button>
        <button id="skipBtn" class="btn" disabled>Skip</button>
        <span id="recHint" class="muted">Press and speak for ~60‚Äì90s. Click Stop when done.</span>
      </div>

      <div id="turnOut" class="stack" style="margin-top:12px;display:none">
        <div class="block">
          <div class="title">Transcript</div>
          <div id="transcript" class="muted"></div>
        </div>
        <div class="block">
          <div class="title">Evaluation</div>
          <div id="scores" class="score"></div>
          <div id="positives" class="muted" style="margin-top:6px"></div>
          <div id="gaps" class="muted" style="margin-top:6px"></div>
          <div id="coaching" style="margin-top:6px"></div>
        </div>
        <div class="block">
          <div class="title">Sample answer</div>
          <div id="sample"></div>
        </div>
      </div>

      <div id="finished" class="stack" style="margin-top:12px;display:none">
        <div class="block">
          <div class="title">Report</div>
          <div id="report"></div>
        </div>
        <div class="row">
          <button id="copySummary" class="btn">Copy summary</button>
          <button id="dlPdf" class="btn">Download PDF</button>
          <button id="restart" class="btn">Restart</button>
        </div>
      </div>
    </section>
  </div>

  <!-- jsPDF for export -->
  <script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>

  <script type="module">
    // ====== CONFIG ======
    const FN = "https://awsuhluvyrxwmogzyfhr.supabase.co/functions/v1/interview-voice";
    const ANON = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImF3c3VobHV2eXJ4d21vZ3p5ZmhyIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTcwNTI5NzksImV4cCI6MjA3MjYyODk3OX0.L_Ye8GAeC61xiW67a_bCTP5Wr7UtRja7o4_Y6mDwaLE";

    // ====== ELs ======
    const roleIn = document.getElementById('role');
    const countSel = document.getElementById('count');
    const speakSel = document.getElementById('speak');
    const startBtn = document.getElementById('start');
    const setupErr = document.getElementById('setupErr');

    const qNum = document.getElementById('qNum');
    const qMax = document.getElementById('qMax');
    const questionEl = document.getElementById('question');
    const timerEl = document.getElementById('timer');
    const recBtn = document.getElementById('recBtn');
    const stopBtn = document.getElementById('stopBtn');
    const redoBtn = document.getElementById('redoBtn');
    const sendBtn = document.getElementById('sendBtn');
    const skipBtn = document.getElementById('skipBtn');
    const pauseBtn = document.getElementById('pauseBtn');
    const resumeBtn = document.getElementById('resumeBtn');
    const recHint = document.getElementById('recHint');

    const turnOut = document.getElementById('turnOut');
    const transcriptEl = document.getElementById('transcript');
    const scoresEl = document.getElementById('scores');
    const positivesEl = document.getElementById('positives');
    const gapsEl = document.getElementById('gaps');
    const coachingEl = document.getElementById('coaching');
    const sampleEl = document.getElementById('sample');

    const finished = document.getElementById('finished');
    const reportEl = document.getElementById('report');
    const dlPdf = document.getElementById('dlPdf');
    const copySummary = document.getElementById('copySummary');
    const restart = document.getElementById('restart');

    // ====== STATE ======
    let role = "Data Scientist";
    let maxQ = 6;
    let qIndex = 0;
    let sessionId = null;
    let currentQ = "";
    let speakingOn = true;
    let runningSummary = "";
    let canRedo = true;

    // guest id (for rate-limit & continuity)
    let guestId = localStorage.getItem("cw_guest_id");
    if (!guestId) {
      guestId = "guest_" + (crypto?.randomUUID?.() || Math.random().toString(36).slice(2));
      localStorage.setItem("cw_guest_id", guestId);
    }

    // ====== TIMER ======
    let tStart = 0, tId = 0, paused = false, elapsed = 0;
    function paint() {
      const s = Math.floor(elapsed/1000);
      const m = String(Math.floor(s/60)).padStart(2,'0');
      const r = String(s%60).padStart(2,'0');
      timerEl.textContent = `${m}:${r}`;
    }
    function startTimer() {
      paused = false; elapsed = 0; paint();
      tStart = Date.now();
      clearInterval(tId);
      tId = setInterval(()=>{ if(!paused){ elapsed = Date.now() - tStart; paint(); }}, 250);
      pauseBtn.disabled = false; resumeBtn.disabled = true;
    }
    function stopTimer(){ clearInterval(tId); }
    function pauseTimer(){ paused = true; pauseBtn.disabled = true; resumeBtn.disabled = false; }
    function resumeTimer(){ paused = false; pauseBtn.disabled = false; resumeBtn.disabled = true; tStart = Date.now() - elapsed; }

    // ====== TTS ======
    function speak(text) {
      if (!speakingOn) return;
      try {
        speechSynthesis.cancel();
        const u = new SpeechSynthesisUtterance(text);
        u.rate = 1; u.pitch = 1; u.lang = "en-US";
        speechSynthesis.speak(u);
      } catch {}
    }

    // ====== RECORDING ======
    let media, rec, chunks = [], haveRecording = false, lastBlob = null, recStartAt = 0;
    async function startRec() {
      media = await navigator.mediaDevices.getUserMedia({ audio: true });
      rec = new MediaRecorder(media, { mimeType: "audio/webm" });
      chunks = []; haveRecording = false; lastBlob = null; recStartAt = Date.now();
      rec.ondataavailable = (e)=> e.data && chunks.push(e.data);
      rec.start();
      recBtn.disabled = true;
      stopBtn.disabled = false;
      sendBtn.disabled = true;
      recHint.textContent = "Recording‚Ä¶ speak clearly. Click Stop when done.";
      startTimer();
    }
    async function stopRec() {
      await new Promise(r => { rec.onstop = r; rec.stop(); });
      media.getTracks().forEach(t => t.stop());
      stopTimer();
      lastBlob = new Blob(chunks, { type: "audio/webm" });
      haveRecording = true;
      const durSec = Math.max(1, Math.round((Date.now() - recStartAt)/1000));
      recHint.textContent = `Recorded ~${durSec}s. You can ‚ÄúSend Answer‚Äù${canRedo ? " or ‚ÄúRedo (1)‚Äù" : ""}.`;
      stopBtn.disabled = true;
      sendBtn.disabled = false;
      redoBtn.disabled = !canRedo;
      // allow another take only once
    }

    // ====== UI helpers ======
    function renderQuestion(q) {
      questionEl.textContent = q;
      turnOut.style.display = 'none';
      transcriptEl.textContent = '';
      scoresEl.innerHTML = '';
      positivesEl.textContent = '';
      gapsEl.textContent = '';
      coachingEl.textContent = '';
      sampleEl.textContent = '';
      recHint.textContent = "Press and speak for ~60‚Äì90s. Click Stop when done.";
      recBtn.disabled = false;
      stopBtn.disabled = true;
      sendBtn.disabled = true;
      redoBtn.disabled = true;
      skipBtn.disabled = false;
      canRedo = true;
      haveRecording = false;
      lastBlob = null;
      startTimer();
    }
    function renderEval(transcript, ev) {
      turnOut.style.display = 'grid';
      transcriptEl.textContent = transcript || "(no speech detected)";
      scoresEl.innerHTML = '';
      const scores = ev?.scores || {};
      Object.keys(scores).forEach(k=>{
        const b = document.createElement('span');
        b.className = 'chip';
        b.textContent = `${k}: ${scores[k]}/5`;
        scoresEl.appendChild(b);
      });
      positivesEl.textContent = ev?.positives?.length ? `üëç ${ev.positives.join(" ‚Ä¢ ")}` : "";
      gapsEl.textContent = ev?.gaps?.length ? `‚ö†Ô∏è ${ev.gaps.join(" ‚Ä¢ ")}` : "";
      coachingEl.textContent = ev?.coaching || "";
      sampleEl.textContent = ev?.sample_answer || "";
    }
    function showError(msg){
      recHint.textContent = msg;
      recHint.classList.add('warn');
      setTimeout(()=>recHint.classList.remove('warn'), 3000);
    }

    // ====== CALLS (matches Step-2 API: start / answer / skip / finish) ======
    async function startInterview() {
      setupErr.style.display = 'none';
      role = (roleIn.value || 'Data Scientist').trim();
      speakingOn = (speakSel.value === 'On');
      maxQ = Number(countSel.value || 6);

      const res = await fetch(FN, {
        method: "POST",
        headers: { "Content-Type": "application/json", "Authorization": `Bearer ${ANON}` },
        body: JSON.stringify({ action: "start", role, count: maxQ, guest_id: guestId })
      });
      const data = await res.json();
      if (!res.ok || !data?.ok) {
        setupErr.textContent = data?.error || `Start failed (${res.status})`;
        setupErr.style.display='block';
        return;
      }

      sessionId = data.session_id;
      qIndex = 0;
      currentQ = data.question;
      runningSummary = data.summary || "";
      qMax.textContent = data.maxQuestions || maxQ;
      qNum.textContent = String(qIndex + 1);

      if (speakingOn) speak(currentQ);
      renderQuestion(currentQ);
      recBtn.focus();
      pauseBtn.disabled = false;
    }

    async function sendAnswer() {
      if (!haveRecording || !lastBlob) { showError("Record your answer first."); return; }
      // lock controls
      recBtn.disabled = true; sendBtn.disabled = true; redoBtn.disabled = true; skipBtn.disabled = true;
      recHint.textContent = "Uploading & evaluating‚Ä¶"; 

      // Use FormData with audio (preferred). The function should accept this.
      const form = new FormData();
      form.append("action","answer");
      form.append("session_id", sessionId);
      form.append("q_index", String(qIndex));
      form.append("question", currentQ);
      form.append("duration_sec", String(Math.max(1, Math.round(elapsed/1000))));
      form.append("audio", lastBlob, "answer.webm");

      const res = await fetch(FN, { method:"POST", headers:{ "Authorization": `Bearer ${ANON}` }, body: form });
      const data = await res.json().catch(()=> ({}));

      if (!res.ok || !data?.ok) {
        showError(data?.error || `Answer failed (${res.status})`);
        // allow resend
        sendBtn.disabled = false; skipBtn.disabled = false;
        return;
      }

      renderEval(data.transcript, data.eval);
      runningSummary = data.updated_summary || runningSummary;

      const nextQ = data.next?.question;
      if (nextQ) {
        qIndex += 1;
        qNum.textContent = String(qIndex + 1);
        currentQ = nextQ;
        if (speakingOn) speak(currentQ);
        renderQuestion(currentQ);
      } else {
        stopTimer();
        await finishInterview();
      }
    }

    async function skipQuestion() {
      // tell server we skipped (for progress tracking)
      const res = await fetch(FN, {
        method: "POST",
        headers: { "Content-Type":"application/json", "Authorization": `Bearer ${ANON}` },
        body: JSON.stringify({ action:"skip", session_id: sessionId, q_index: qIndex, question: currentQ })
      });
      const data = await res.json().catch(()=> ({}));
      if (!res.ok || !data?.ok) {
        showError(data?.error || `Skip failed (${res.status})`);
        return;
      }
      const nextQ = data.next?.question;
      if (nextQ) {
        qIndex += 1;
        qNum.textContent = String(qIndex + 1);
        currentQ = nextQ;
        if (speakingOn) speak(currentQ);
        renderQuestion(currentQ);
      } else {
        stopTimer();
        await finishInterview();
      }
    }

    async function finishInterview() {
      // fetch final report
      const res = await fetch(FN, {
        method: "POST",
        headers: { "Content-Type": "application/json", "Authorization": `Bearer ${ANON}` },
        body: JSON.stringify({ action: "finish", session_id: sessionId })
      });
      const data = await res.json().catch(()=> ({}));
      finished.style.display = 'grid';
      const r = data?.report || {};
      reportEl.innerHTML = `
        <div class="muted"><strong>Overall:</strong> ${r.overall_signal || '‚Äî'}</div>
        <div class="sep"></div>
        <div>${r.summary || ''}</div>
        ${Array.isArray(r.strengths) ? `<div class="sep"></div><div><strong>Strengths:</strong> ${r.strengths.join(" ‚Ä¢ ")}</div>` : ""}
        ${Array.isArray(r.improvements) ? `<div class="sep"></div><div><strong>Improvements:</strong> ${r.improvements.join(" ‚Ä¢ ")}</div>` : ""}
        ${Array.isArray(r.next_steps) ? `<div class="sep"></div><div><strong>Next steps:</strong> ${r.next_steps.join(" ‚Ä¢ ")}</div>` : ""}
      `;
    }

    // ====== PDF & COPY ======
    dlPdf.onclick = ()=>{
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF({ unit: "pt", format: "a4" });
      const title = `CareerWise Mock Interview ‚Äî ${role}`;
      doc.setFont("helvetica","bold"); doc.setFontSize(14); doc.text(title, 40, 40);
      doc.setFont("helvetica",""); doc.setFontSize(11);
      const text = (reportEl.innerText || "").split("\n");
      let y = 70;
      text.forEach(line => { doc.text(line, 40, y); y += 16; if (y > 780){ doc.addPage(); y = 40; }});
      const fname = `mock-interview_${role.replace(/\s+/g,'-').toLowerCase()}.pdf`;
      doc.save(fname);
    };
    copySummary.onclick = async ()=>{
      try { await navigator.clipboard.writeText(reportEl.innerText || ""); copySummary.textContent = "Copied ‚úì"; setTimeout(()=>copySummary.textContent="Copy summary", 1200); } catch {}
    };
    restart.onclick = ()=> location.reload();

    // ====== BINDINGS ======
    startBtn.onclick = startInterview;

    recBtn.onmousedown = startRec; // desktop
    recBtn.onmouseup = stopRec;
    recBtn.ontouchstart = (e)=>{ e.preventDefault(); startRec(); };
    recBtn.ontouchend = (e)=>{ e.preventDefault(); stopRec(); };

    stopBtn.onclick = stopRec;

    redoBtn.onclick = ()=>{
      if (!canRedo) return;
      canRedo = false;
      redoBtn.disabled = true;
      sendBtn.disabled = true;
      recBtn.disabled = false;
      recHint.textContent = "Redo enabled (0 left). Press & hold to re-record, then Stop.";
    };

    sendBtn.onclick = sendAnswer;
    skipBtn.onclick = skipQuestion;

    pauseBtn.onclick = pauseTimer;
    resumeBtn.onclick = resumeTimer;

    // ====== DEFAULTS ======
    roleIn.value = "Data Scientist";
    // Disable action controls until start
    [recBtn, stopBtn, redoBtn, sendBtn, skipBtn, pauseBtn, resumeBtn].forEach(b=>b.disabled = true);
  </script>
</body>
</html>
